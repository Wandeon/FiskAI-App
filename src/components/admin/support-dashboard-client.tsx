"use client"
import { useState } from "react"
import { useRouter, useSearchParams } from "next/navigation"
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
import { Badge } from "@/components/ui/badge"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { MessageSquare, Search, AlertCircle, Clock, CheckCircle2, Building2, AlertTriangle, Filter, RefreshCw } from "lucide-react"
import type { SupportTicketStatus, SupportTicketPriority, TicketCategory } from "@prisma/client"

interface Ticket { id: string; title: string; body: string | null; status: SupportTicketStatus; priority: SupportTicketPriority; category: TicketCategory; createdAt: Date; updatedAt: Date; company: { id: string; name: string }; _count: { messages: number } }
interface Company { id: string; name: string; ticketCount: number }
interface Stats { total: number; open: number; inProgress: number; resolved: number; closed: number; urgent: number; high: number; companiesWithOpenTickets: number }
interface Props { tickets: Ticket[]; companies: Company[]; stats: Stats; currentStatus?: string; currentCategory?: string; currentPriority?: string; currentCompany?: string; currentSearch?: string }

function getStatusIcon(s: SupportTicketStatus) { return s === "OPEN" ? <AlertCircle className="h-4 w-4 text-danger" /> : s === "IN_PROGRESS" ? <Clock className="h-4 w-4 text-primary" /> : s === "RESOLVED" ? <CheckCircle2 className="h-4 w-4 text-success" /> : s === "CLOSED" ? <CheckCircle2 className="h-4 w-4 text-muted" /> : <MessageSquare className="h-4 w-4" /> }
function getStatusBadgeVariant(s: SupportTicketStatus): "danger" | "warning" | "success" | "secondary" | "default" { return s === "OPEN" ? "danger" : s === "IN_PROGRESS" ? "warning" : s === "RESOLVED" ? "success" : s === "CLOSED" ? "secondary" : "default" }
function getStatusLabel(s: SupportTicketStatus): string { return s === "OPEN" ? "Otvoren" : s === "IN_PROGRESS" ? "U tijeku" : s === "RESOLVED" ? "Riješen" : s === "CLOSED" ? "Zatvoren" : s }
function getPriorityBadgeVariant(p: SupportTicketPriority): "danger" | "warning" | "outline" | "secondary" | "default" { return p === "URGENT" ? "danger" : p === "HIGH" ? "warning" : p === "NORMAL" ? "outline" : p === "LOW" ? "secondary" : "default" }
function getPriorityLabel(p: SupportTicketPriority): string { return p === "URGENT" ? "Hitno" : p === "HIGH" ? "Visok" : p === "NORMAL" ? "Normalan" : p === "LOW" ? "Nizak" : p }
function getCategoryLabel(c: TicketCategory): string { return c === "TECHNICAL" ? "Tehnički" : c === "BILLING" ? "Naplata" : c === "ACCOUNTING" ? "Računovodstvo" : c === "GENERAL" ? "Općenito" : c }

export function SupportDashboardClient({ tickets, companies, stats, currentStatus, currentCategory, currentPriority, currentCompany, currentSearch }: Props) {
  const router = useRouter(), searchParams = useSearchParams(), [searchInput, setSearchInput] = useState(currentSearch || ""), [isUpdating, setIsUpdating] = useState<string | null>(null)
  const updateFilter = (k: string, v: string) => { const p = new URLSearchParams(searchParams.toString()); v === "ALL" || !v ? p.delete(k) : p.set(k, v); router.push("/support" + (p.toString() ? "?" + p.toString() : "")) }
  const handleSearch = () => { const p = new URLSearchParams(searchParams.toString()); searchInput.trim() ? p.set("search", searchInput.trim()) : p.delete("search"); router.push("/support" + (p.toString() ? "?" + p.toString() : "")) }
  const updateTicketStatus = async (id: string, status: SupportTicketStatus) => { setIsUpdating(id); try { const r = await fetch("/api/admin/support/tickets/" + id + "/status", { method: "PATCH", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ status }) }); if (r.ok) router.refresh() } catch (e) { console.error(e) } finally { setIsUpdating(null) } }
  const hasFilters = currentStatus || currentCategory || currentPriority || currentCompany || currentSearch
  return (
    <div className="space-y-6">
      <div className="flex items-center gap-3"><MessageSquare className="h-8 w-8 text-secondary" /><div><h1 className="text-2xl font-bold text-foreground">Podrška</h1><p className="text-sm text-tertiary">Upravljanje zahtjevima za podršku svih klijenata</p></div></div>
      <div className="grid gap-4 md:grid-cols-4 lg:grid-cols-8">
        <Card><CardHeader className="pb-2"><CardTitle className="text-sm font-medium">Ukupno</CardTitle></CardHeader><CardContent><div className="text-2xl font-bold">{stats.total}</div></CardContent></Card>
        <Card><CardHeader className="pb-2"><CardTitle className="text-sm font-medium flex items-center gap-2"><AlertCircle className="h-4 w-4 text-danger" />Otvoreni</CardTitle></CardHeader><CardContent><div className="text-2xl font-bold text-danger">{stats.open}</div></CardContent></Card>
        <Card><CardHeader className="pb-2"><CardTitle className="text-sm font-medium flex items-center gap-2"><Clock className="h-4 w-4 text-warning" />U tijeku</CardTitle></CardHeader><CardContent><div className="text-2xl font-bold text-warning">{stats.inProgress}</div></CardContent></Card>
        <Card><CardHeader className="pb-2"><CardTitle className="text-sm font-medium flex items-center gap-2"><CheckCircle2 className="h-4 w-4 text-success" />Riješeni</CardTitle></CardHeader><CardContent><div className="text-2xl font-bold text-success">{stats.resolved}</div></CardContent></Card>
        <Card><CardHeader className="pb-2"><CardTitle className="text-sm font-medium">Zatvoreni</CardTitle></CardHeader><CardContent><div className="text-2xl font-bold">{stats.closed}</div></CardContent></Card>
        <Card><CardHeader className="pb-2"><CardTitle className="text-sm font-medium flex items-center gap-2"><AlertTriangle className="h-4 w-4 text-danger" />Hitni</CardTitle></CardHeader><CardContent><div className="text-2xl font-bold text-danger">{stats.urgent}</div></CardContent></Card>
        <Card><CardHeader className="pb-2"><CardTitle className="text-sm font-medium">Visok prioritet</CardTitle></CardHeader><CardContent><div className="text-2xl font-bold">{stats.high}</div></CardContent></Card>
        <Card><CardHeader className="pb-2"><CardTitle className="text-sm font-medium flex items-center gap-2"><Building2 className="h-4 w-4" />Tvrtke</CardTitle></CardHeader><CardContent><div className="text-2xl font-bold">{stats.companiesWithOpenTickets}</div><p className="text-xs text-muted">s aktivnim zahtjevima</p></CardContent></Card>
      </div>
      <Card><CardHeader><CardTitle className="flex items-center justify-between"><span className="flex items-center gap-2"><Filter className="h-5 w-5" />Filteri</span>{hasFilters && <Button variant="ghost" size="sm" onClick={() => { setSearchInput(""); router.push("/support") }}><RefreshCw className="h-4 w-4 mr-2" />Očisti filtere</Button>}</CardTitle></CardHeader><CardContent><div className="grid gap-4 md:grid-cols-5"><div className="space-y-2 md:col-span-2"><label className="text-sm font-medium">Pretraži</label><div className="flex gap-2"><Input placeholder="Pretraži po naslovu..." value={searchInput} onChange={e => setSearchInput(e.target.value)} onKeyDown={e => e.key === "Enter" && handleSearch()} /><Button variant="secondary" onClick={handleSearch}><Search className="h-4 w-4" /></Button></div></div><div className="space-y-2"><label className="text-sm font-medium">Tvrtka</label><Select value={currentCompany || "ALL"} onValueChange={v => updateFilter("company", v)}><SelectTrigger><SelectValue placeholder="Sve tvrtke" /></SelectTrigger><SelectContent><SelectItem value="ALL">Sve tvrtke</SelectItem>{companies.map(c => <SelectItem key={c.id} value={c.id}>{c.name} ({c.ticketCount})</SelectItem>)}</SelectContent></Select></div><div className="space-y-2"><label className="text-sm font-medium">Status</label><Select value={currentStatus || "ALL"} onValueChange={v => updateFilter("status", v)}><SelectTrigger><SelectValue placeholder="Svi statusi" /></SelectTrigger><SelectContent><SelectItem value="ALL">Svi statusi</SelectItem><SelectItem value="OPEN">Otvoren</SelectItem><SelectItem value="IN_PROGRESS">U tijeku</SelectItem><SelectItem value="RESOLVED">Riješen</SelectItem><SelectItem value="CLOSED">Zatvoren</SelectItem></SelectContent></Select></div><div className="space-y-2"><label className="text-sm font-medium">Prioritet</label><Select value={currentPriority || "ALL"} onValueChange={v => updateFilter("priority", v)}><SelectTrigger><SelectValue placeholder="Svi prioriteti" /></SelectTrigger><SelectContent><SelectItem value="ALL">Svi prioriteti</SelectItem><SelectItem value="URGENT">Hitno</SelectItem><SelectItem value="HIGH">Visok</SelectItem><SelectItem value="NORMAL">Normalan</SelectItem><SelectItem value="LOW">Nizak</SelectItem></SelectContent></Select></div></div></CardContent></Card>
      <Card><CardHeader><CardTitle className="flex items-center justify-between"><span>Zahtjevi za podršku ({tickets.length})</span>{hasFilters && <Badge variant="secondary">Filtrirano od ukupno {stats.total}</Badge>}</CardTitle></CardHeader><CardContent>{tickets.length === 0 ? <div className="flex flex-col items-center justify-center py-12"><MessageSquare className="h-12 w-12 text-muted mb-4" /><p className="text-muted-foreground">Nema zahtjeva za podršku</p><p className="text-sm text-muted">{hasFilters ? "Pokušajte prilagoditi filtere" : "Trenutno nema aktivnih zahtjeva za podršku"}</p></div> : <div className="space-y-4">{tickets.map(t => <div key={t.id} className="flex items-start gap-4 rounded-lg border border-border p-4 hover:bg-surface-1 transition-colors"><div className="mt-1">{getStatusIcon(t.status)}</div><div className="flex-1 min-w-0"><div className="flex items-start justify-between gap-4 mb-2"><div className="flex-1"><h3 className="font-semibold mb-1">{t.title}</h3><div className="flex items-center gap-2 mb-2"><Building2 className="h-3 w-3 text-muted" /><span className="text-sm text-primary">{t.company.name}</span></div></div><div className="flex items-center gap-2 flex-wrap justify-end"><Badge variant={getStatusBadgeVariant(t.status)}>{getStatusLabel(t.status)}</Badge><Badge variant={getPriorityBadgeVariant(t.priority)}>{getPriorityLabel(t.priority)}</Badge><Badge variant="outline">{getCategoryLabel(t.category)}</Badge></div></div>{t.body && <p className="text-sm text-muted-foreground line-clamp-2 mb-2">{t.body}</p>}<div className="flex items-center justify-between"><div className="flex items-center gap-4 text-xs text-muted-foreground"><span>Kreirano {new Date(t.createdAt).toLocaleDateString("hr-HR", { day: "numeric", month: "short", year: "numeric" })}</span>{t._count.messages > 0 && <span className="flex items-center gap-1"><MessageSquare className="h-3 w-3" />{t._count.messages} poruka</span>}</div><div className="flex items-center gap-2">{t.status === "OPEN" && <Button variant="outline" size="sm" disabled={isUpdating === t.id} onClick={() => updateTicketStatus(t.id, "IN_PROGRESS")}>{isUpdating === t.id ? <RefreshCw className="h-3 w-3 animate-spin" /> : "Preuzmi"}</Button>}{t.status === "IN_PROGRESS" && <Button variant="outline" size="sm" disabled={isUpdating === t.id} onClick={() => updateTicketStatus(t.id, "RESOLVED")}>{isUpdating === t.id ? <RefreshCw className="h-3 w-3 animate-spin" /> : "Riješi"}</Button>}{t.status === "RESOLVED" && <Button variant="outline" size="sm" disabled={isUpdating === t.id} onClick={() => updateTicketStatus(t.id, "CLOSED")}>{isUpdating === t.id ? <RefreshCw className="h-3 w-3 animate-spin" /> : "Zatvori"}</Button>}{t.status === "CLOSED" && <Button variant="outline" size="sm" disabled={isUpdating === t.id} onClick={() => updateTicketStatus(t.id, "OPEN")}>{isUpdating === t.id ? <RefreshCw className="h-3 w-3 animate-spin" /> : "Ponovno otvori"}</Button>}</div></div></div></div>)}</div>}</CardContent></Card>
    </div>
  )
}
