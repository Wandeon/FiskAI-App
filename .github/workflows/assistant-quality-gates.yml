# .github/workflows/assistant-quality-gates.yml
name: Assistant Quality Gates

on:
  push:
    paths:
      - 'src/lib/assistant/**'
      - 'src/components/assistant-v2/**'
      - 'e2e/assistant/**'
  pull_request:
    paths:
      - 'src/lib/assistant/**'
      - 'src/components/assistant-v2/**'
      - 'e2e/assistant/**'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run assistant unit tests
        run: npx vitest run src/lib/assistant/ src/components/assistant-v2/ --reporter=verbose

      - name: Run quality gate tests
        run: npx vitest run src/lib/assistant/__tests__/quality-gates.test.ts --reporter=verbose

  accessibility-tests:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run axe-core tests
        run: npx vitest run src/components/assistant-v2/__tests__/accessibility --reporter=verbose

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    # Phase 8 Lock-Down: E2E tests now BLOCKING
    # All tests must pass for compliance - no exceptions without ADR
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps chromium

      - name: Build application
        run: npm run build
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"
          SENTRY_SKIP_SOURCE_MAP_UPLOAD: "true"
          # Required for build - actual values not needed for E2E tests
          DATABASE_URL: "postgresql://ci:ci@localhost:5432/ci"
          RESEND_API_KEY: "re_test_dummy_key"
          REDIS_URL: "redis://localhost:6379"
          NEXTAUTH_SECRET: "ci-test-secret-not-for-production"
          NEXTAUTH_URL: "http://localhost:3000"

      - name: Run E2E tests
        run: npx playwright test e2e/assistant/ --project=chromium

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 7

  quality-summary:
    name: Quality Summary
    needs: [unit-tests, accessibility-tests, e2e-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          # Unit and Accessibility tests must pass
          if [ "${{ needs.unit-tests.result }}" != "success" ] || \
             [ "${{ needs.accessibility-tests.result }}" != "success" ]; then
            echo "Quality gates failed"
            exit 1
          fi

          # Phase 8 Lock-Down: E2E tests are now BLOCKING
          if [ "${{ needs.e2e-tests.result }}" != "success" ]; then
            echo "E2E tests failed - blocking deployment"
            exit 1
          fi

          echo "All quality gates passed"
