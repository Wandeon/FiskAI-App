// =============================================================================
// FiskAI - Company & Business Setup Models
// =============================================================================

// Legal forms for Croatian businesses
enum LegalForm {
  OBRT_PAUSAL  // Paušalni obrt - flat-rate taxation
  OBRT_REAL    // Obrt - actual income/expenses
  DOO          // d.o.o. - Limited liability company
  JDOO         // j.d.o.o. - Simple limited liability company
}

// Tracks where company data originated from
enum DataSource {
  MANUAL          // User entered manually
  OCR_OBRTNICA    // Extracted from Obrtnica document
  OCR_SUDSKO      // Extracted from Sudsko rješenje
  VIES            // Fetched from EU VIES API
  SUDSKI_REGISTAR // Fetched from Croatian court registry
}

model Company {
  id        String   @id @default(cuid())
  name      String
  oib       String   @unique // Croatian tax number (11 digits)
  legalForm LegalForm @default(OBRT_PAUSAL)

  // Address fields
  address   String?
  city      String?
  zipCode   String?
  country   String   @default("HR")

  // Tax and fiscal settings
  isVatPayer    Boolean @default(false)
  vatNumber     String? // EU VAT format: HRxxxxxxxxxxx
  acceptsCash   Boolean @default(false)
  fiscalEnabled Boolean @default(false)

  // Contact information
  email String?
  phone String?
  iban  String?

  // Onboarding progress
  onboardingStep     Int     @default(0)
  onboardingComplete Boolean @default(false)

  // Data tracking
  dataSource   DataSource @default(MANUAL)
  featureFlags Json?      // For paušalni-specific options and feature toggles

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members          CompanyMember[]
  businessPremises BusinessPremises[]
  invoices         Invoice[]
  contacts         Contact[]
  products         Product[]

  @@map("companies")
}

model CompanyMember {
  id        String      @id @default(cuid())
  userId    String
  companyId String
  role      CompanyRole @default(MEMBER)
  createdAt DateTime    @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@map("company_members")
}

enum CompanyRole {
  OWNER
  ADMIN
  MEMBER
}

// Croatian fiscalization requirements
model BusinessPremises {
  id        String   @id @default(cuid())
  companyId String
  code      String   // Oznaka poslovnog prostora (e.g., "1", "PROD")
  name      String
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  paymentDevices PaymentDevice[]
  invoices       Invoice[]

  @@unique([companyId, code])
  @@map("business_premises")
}

model PaymentDevice {
  id                 String   @id @default(cuid())
  businessPremisesId String
  code               String   // Oznaka naplatnog uređaja (e.g., "1", "2")
  name               String?
  isActive           Boolean  @default(true)
  createdAt          DateTime @default(now())

  businessPremises BusinessPremises @relation(fields: [businessPremisesId], references: [id], onDelete: Cascade)
  invoices         Invoice[]

  @@unique([businessPremisesId, code])
  @@map("payment_devices")
}

model InvoiceSequence {
  id                 String   @id @default(cuid())
  companyId          String
  businessPremisesId String
  paymentDeviceId    String
  year               Int
  lastNumber         Int      @default(0)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([companyId, businessPremisesId, paymentDeviceId, year])
  @@map("invoice_sequences")
}
