generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  name                String?
  emailVerified       DateTime?
  image               String?
  passwordHash        String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  systemRole          SystemRole           @default(USER)
  accounts            Account[]
  companies           CompanyUser[]
  passwordResetTokens PasswordResetToken[]
  sessions            Session[]
  assignmentsMade     StaffAssignment[]    @relation("AssignmentsMade")
  staffAssignments    StaffAssignment[]    @relation("StaffAssignments")
  verificationCodes   VerificationCode[]
  webAuthnCredentials WebAuthnCredential[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model VerificationCode {
  id        String               @id @default(cuid())
  email     String
  userId    String?
  codeHash  String
  type      VerificationCodeType
  expiresAt DateTime
  attempts  Int                  @default(0)
  createdAt DateTime             @default(now())
  user      User?                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([expiresAt])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Company {
  id                             String               @id @default(cuid())
  name                           String
  oib                            String               @unique
  vatNumber                      String?
  address                        String
  city                           String
  postalCode                     String
  country                        String               @default("HR")
  email                          String?
  phone                          String?
  iban                           String?
  isVatPayer                     Boolean              @default(false)
  eInvoiceProvider               String?
  createdAt                      DateTime             @default(now())
  updatedAt                      DateTime             @updatedAt
  eInvoiceApiKeyEncrypted        String?
  legalForm                      String?
  entitlements                   Json?
  featureFlags                   Json?
  deviceCode                     String               @default("1")
  fiscalEnabled                  Boolean              @default(false)
  fiscalEnvironment              FiscalEnv            @default(PROD)
  premisesCode                   String               @default("1")
  stripeCustomerId               String?              @unique
  stripeSubscriptionId           String?              @unique
  subscriptionStatus             String?              @default("trialing")
  subscriptionPlan               String?              @default("pausalni")
  trialEndsAt                    DateTime?
  subscriptionCurrentPeriodStart DateTime?
  subscriptionCurrentPeriodEnd   DateTime?
  invoiceLimit                   Int                  @default(50)
  userLimit                      Int                  @default(1)
  stripeTerminalLocationId       String?
  stripeTerminalReaderId         String?
  aiUsage                        AIUsage[]
  auditLogs                      AuditLog[]
  bankAccounts                   BankAccount[]
  bankConnections                BankConnection[]
  businessPremises               BusinessPremises[]
  users                          CompanyUser[]
  contacts                       Contact[]
  eInvoices                      EInvoice[]
  emailAttachments               EmailAttachment[]
  emailConnections               EmailConnection[]
  emailImportRules               EmailImportRule[]
  expenses                       Expense[]
  expenseCategories              ExpenseCategory[]
  fiscalCertificates             FiscalCertificate[]
  fiscalRequests                 FiscalRequest[]
  importJobs                     ImportJob[]
  invoiceSequences               InvoiceSequence[]
  paymentDevices                 PaymentDevice[]
  potentialDuplicates            PotentialDuplicate[]
  products                       Product[]
  recurringExpenses              RecurringExpense[]
  savedReports                   SavedReport[]
  assignedStaff                  StaffAssignment[]    @relation("AssignedStaff")
  statements                     Statement[]
  statementPages                 StatementPage[]
  supportTickets                 SupportTicket[]
  statementTransactions          Transaction[]
}

model CompanyUser {
  id                 String    @id @default(cuid())
  userId             String
  companyId          String
  role               Role      @default(MEMBER)
  isDefault          Boolean   @default(false)
  createdAt          DateTime  @default(now())
  notificationSeenAt DateTime?
  company            Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
}

model StaffAssignment {
  id         String   @id @default(cuid())
  staffId    String
  companyId  String
  assignedAt DateTime @default(now())
  assignedBy String
  notes      String?
  assigner   User     @relation("AssignmentsMade", fields: [assignedBy], references: [id])
  company    Company  @relation("AssignedStaff", fields: [companyId], references: [id], onDelete: Cascade)
  staff      User     @relation("StaffAssignments", fields: [staffId], references: [id], onDelete: Cascade)

  @@unique([staffId, companyId])
  @@index([staffId])
  @@index([companyId])
}

model Contact {
  id                String      @id @default(cuid())
  companyId         String
  type              ContactType
  name              String
  oib               String?
  vatNumber         String?
  address           String?
  city              String?
  postalCode        String?
  country           String      @default("HR")
  email             String?
  phone             String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  paymentTermsDays  Int         @default(15)
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  eInvoicesAsBuyer  EInvoice[]  @relation("EInvoiceBuyer")
  eInvoicesAsSeller EInvoice[]  @relation("EInvoiceSeller")
  expensesAsVendor  Expense[]   @relation("ExpenseVendor")

  @@unique([companyId, oib])
  @@index([companyId])
  @@index([oib])
}

model Product {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  description String?
  sku         String?
  unit        String   @default("C62")
  price       Decimal  @db.Decimal(10, 2)
  vatRate     Decimal  @default(25) @db.Decimal(5, 2)
  vatCategory String   @default("S")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model EInvoice {
  id                String            @id @default(cuid())
  companyId         String
  direction         EInvoiceDirection
  sellerId          String?
  buyerId           String?
  invoiceNumber     String
  issueDate         DateTime
  dueDate           DateTime?
  currency          String            @default("EUR")
  buyerReference    String?
  netAmount         Decimal           @db.Decimal(10, 2)
  vatAmount         Decimal           @db.Decimal(10, 2)
  totalAmount       Decimal           @db.Decimal(10, 2)
  status            EInvoiceStatus    @default(DRAFT)
  jir               String?
  zki               String?
  fiscalizedAt      DateTime?
  ublXml            String?
  providerRef       String?
  providerStatus    String?
  providerError     String?
  archivedAt        DateTime?
  archiveRef        String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  sentAt            DateTime?
  receivedAt        DateTime?
  type              InvoiceType       @default(E_INVOICE)
  internalReference String?
  notes             String?
  convertedFromId   String?
  paidAt            DateTime?
  bankAccount       String?
  includeBarcode    Boolean           @default(true)
  importJobId       String?           @unique
  paymentModel      String?
  paymentReference  String?
  vendorBankName    String?
  vendorIban        String?
  fiscalStatus      String?
  operatorOib       String?
  paymentMethod     PaymentMethod?
  emailMessageId    String?
  emailDeliveredAt  DateTime?
  emailOpenedAt     DateTime?
  emailClickedAt    DateTime?
  emailBouncedAt    DateTime?
  emailBounceReason String?
  bankTransactions  BankTransaction[]
  buyer             Contact?          @relation("EInvoiceBuyer", fields: [buyerId], references: [id])
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  convertedFrom     EInvoice?         @relation("InvoiceConversion", fields: [convertedFromId], references: [id])
  convertedTo       EInvoice[]        @relation("InvoiceConversion")
  importJob         ImportJob?        @relation(fields: [importJobId], references: [id])
  seller            Contact?          @relation("EInvoiceSeller", fields: [sellerId], references: [id])
  lines             EInvoiceLine[]
  fiscalRequests    FiscalRequest[]

  @@unique([companyId, invoiceNumber])
  @@index([companyId])
  @@index([status])
  @@index([invoiceNumber])
  @@index([direction])
  @@index([type])
  @@index([emailMessageId])
}

model EInvoiceLine {
  id          String   @id @default(cuid())
  eInvoiceId  String
  lineNumber  Int
  description String
  quantity    Decimal  @db.Decimal(10, 3)
  unit        String   @default("C62")
  unitPrice   Decimal  @db.Decimal(10, 2)
  netAmount   Decimal  @db.Decimal(10, 2)
  vatRate     Decimal  @db.Decimal(5, 2)
  vatCategory String   @default("S")
  vatAmount   Decimal  @db.Decimal(10, 2)
  eInvoice    EInvoice @relation(fields: [eInvoiceId], references: [id], onDelete: Cascade)

  @@index([eInvoiceId])
}

model AuditLog {
  id        String      @id @default(cuid())
  companyId String
  userId    String?
  action    AuditAction
  entity    String
  entityId  String
  changes   Json?
  ipAddress String?
  userAgent String?
  timestamp DateTime    @default(now())
  company   Company     @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@index([entity, entityId])
  @@index([timestamp])
}

model BusinessPremises {
  id        String            @id @default(cuid())
  companyId String
  code      Int
  name      String
  address   String?
  isDefault Boolean           @default(false)
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  company   Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sequences InvoiceSequence[]
  devices   PaymentDevice[]

  @@unique([companyId, code])
  @@index([companyId])
}

model PaymentDevice {
  id                 String           @id @default(cuid())
  companyId          String
  businessPremisesId String
  code               Int
  name               String
  isDefault          Boolean          @default(false)
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  businessPremises   BusinessPremises @relation(fields: [businessPremisesId], references: [id], onDelete: Cascade)
  company            Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([businessPremisesId, code])
  @@index([companyId])
}

model InvoiceSequence {
  id                 String           @id @default(cuid())
  companyId          String
  businessPremisesId String
  year               Int
  lastNumber         Int              @default(0)
  updatedAt          DateTime         @updatedAt
  businessPremises   BusinessPremises @relation(fields: [businessPremisesId], references: [id], onDelete: Cascade)
  company            Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([businessPremisesId, year])
  @@index([companyId])
}

model Expense {
  id               String            @id @default(cuid())
  companyId        String
  vendorId         String?
  categoryId       String
  description      String
  date             DateTime
  dueDate          DateTime?
  netAmount        Decimal           @db.Decimal(10, 2)
  vatAmount        Decimal           @db.Decimal(10, 2)
  totalAmount      Decimal           @db.Decimal(10, 2)
  vatDeductible    Boolean           @default(true)
  currency         String            @default("EUR")
  status           ExpenseStatus     @default(DRAFT)
  paymentMethod    PaymentMethod?
  paymentDate      DateTime?
  receiptUrl       String?
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  bankTransactions BankTransaction[]
  category         ExpenseCategory   @relation(fields: [categoryId], references: [id])
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendor           Contact?          @relation("ExpenseVendor", fields: [vendorId], references: [id])

  @@index([companyId])
  @@index([date])
  @@index([status])
  @@index([categoryId])
}

model ExpenseCategory {
  id                   String    @id @default(cuid())
  companyId            String?
  name                 String
  code                 String
  vatDeductibleDefault Boolean   @default(true)
  isActive             Boolean   @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  expenses             Expense[]
  company              Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, code])
  @@index([companyId])
}

model RecurringExpense {
  id          String    @id @default(cuid())
  companyId   String
  vendorId    String?
  categoryId  String
  description String
  netAmount   Decimal   @db.Decimal(10, 2)
  vatAmount   Decimal   @db.Decimal(10, 2)
  totalAmount Decimal   @db.Decimal(10, 2)
  frequency   Frequency
  nextDate    DateTime
  endDate     DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([nextDate])
}

model SavedReport {
  id        String         @id @default(cuid())
  companyId String
  userId    String
  name      String
  type      ReportType
  filters   Json
  schedule  ReportSchedule @default(NONE)
  emailTo   String[]
  createdAt DateTime       @default(now())
  lastRunAt DateTime?
  company   Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
}

model BankAccount {
  id                    String            @id @default(cuid())
  companyId             String
  name                  String
  iban                  String
  bankName              String
  currency              String            @default("EUR")
  currentBalance        Decimal           @db.Decimal(12, 2)
  lastSyncAt            DateTime?
  isDefault             Boolean           @default(false)
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  connectionExpiresAt   DateTime?
  connectionStatus      ConnectionStatus  @default(MANUAL)
  syncProvider          SyncProvider?
  syncProviderAccountId String?
  company               Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  connection            BankConnection?
  imports               BankImport[]
  transactions          BankTransaction[]
  importJobs            ImportJob[]
  statements            Statement[]

  @@unique([companyId, iban])
  @@index([companyId])
  @@index([connectionStatus])
}

model BankTransaction {
  id               String            @id @default(cuid())
  companyId        String
  bankAccountId    String
  date             DateTime
  description      String
  amount           Decimal           @db.Decimal(12, 2)
  balance          Decimal           @db.Decimal(12, 2)
  reference        String?
  counterpartyName String?
  counterpartyIban String?
  matchedInvoiceId String?
  matchedExpenseId String?
  matchStatus      MatchStatus       @default(UNMATCHED)
  matchedAt        DateTime?
  matchedBy        String?
  createdAt        DateTime          @default(now())
  confidenceScore  Int?
  externalId       String?
  source           TransactionSource @default(MANUAL)
  bankAccount      BankAccount       @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  matchedExpense   Expense?          @relation(fields: [matchedExpenseId], references: [id])
  matchedInvoice   EInvoice?         @relation(fields: [matchedInvoiceId], references: [id])

  @@index([companyId])
  @@index([bankAccountId])
  @@index([matchStatus])
  @@index([date])
  @@index([externalId])
}

model BankConnection {
  id                   String           @id @default(cuid())
  companyId            String
  bankAccountId        String           @unique
  provider             SyncProvider
  providerConnectionId String
  institutionId        String
  institutionName      String
  status               ConnectionStatus @default(MANUAL)
  authorizedAt         DateTime?
  expiresAt            DateTime?
  lastError            String?
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  bankAccount          BankAccount      @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  company              Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
  @@index([providerConnectionId])
}

model PotentialDuplicate {
  id              String               @id @default(cuid())
  companyId       String
  transactionAId  String
  transactionBId  String
  similarityScore Float
  reason          String
  status          DuplicateStatus      @default(PENDING)
  resolvedAt      DateTime?
  resolvedBy      String?
  resolution      DuplicateResolution?
  createdAt       DateTime             @default(now())
  company         Company              @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
}

model EmailConnection {
  id              String                @id @default(cuid())
  companyId       String
  provider        EmailProvider
  emailAddress    String
  status          EmailConnectionStatus @default(CONNECTED)
  accessTokenEnc  String?
  refreshTokenEnc String
  tokenExpiresAt  DateTime?
  scopes          String[]
  lastSyncAt      DateTime?
  syncCursor      String?
  lastError       String?
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt
  attachments     EmailAttachment[]
  company         Company               @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importRules     EmailImportRule[]

  @@unique([companyId, emailAddress])
  @@index([companyId])
  @@index([status])
}

model EmailImportRule {
  id               String          @id @default(cuid())
  connectionId     String
  companyId        String
  senderEmail      String?
  senderDomain     String?
  subjectContains  String?
  filenameContains String?
  isActive         Boolean         @default(true)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  company          Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  connection       EmailConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([companyId])
}

model EmailAttachment {
  id                   String           @id @default(cuid())
  companyId            String
  connectionId         String
  providerMessageId    String
  providerAttachmentId String?
  contentHash          String
  receivedAt           DateTime
  senderEmail          String
  subject              String
  filename             String
  mimeType             String
  sizeBytes            Int
  r2Key                String
  status               AttachmentStatus @default(PENDING)
  importJobId          String?          @unique
  createdAt            DateTime         @default(now())
  updatedAt            DateTime         @updatedAt
  company              Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  connection           EmailConnection  @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  importJob            ImportJob?       @relation(fields: [importJobId], references: [id])

  @@unique([connectionId, contentHash])
  @@index([companyId])
  @@index([connectionId])
  @@index([status])
}

model BankImport {
  id               String       @id @default(cuid())
  companyId        String
  bankAccountId    String
  fileName         String
  format           ImportFormat
  transactionCount Int
  importedAt       DateTime     @default(now())
  importedBy       String
  bankAccount      BankAccount  @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([bankAccountId])
}

model ImportJob {
  id              String           @id @default(cuid())
  companyId       String
  userId          String
  bankAccountId   String?
  fileChecksum    String
  originalName    String
  storagePath     String
  status          JobStatus        @default(PENDING)
  tierUsed        TierType?
  failureReason   String?
  pagesProcessed  Int              @default(0)
  pagesFailed     Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  documentType    DocumentType?
  extractedData   Json?
  invoice         EInvoice?
  emailAttachment EmailAttachment?
  bankAccount     BankAccount?     @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  statement       Statement?

  @@index([companyId])
  @@index([bankAccountId])
  @@index([status])
  @@index([bankAccountId, fileChecksum])
}

model Statement {
  id                  String          @id @default(cuid())
  importJobId         String          @unique
  companyId           String
  bankAccountId       String
  statementDate       DateTime
  periodStart         DateTime
  periodEnd           DateTime
  sequenceNumber      Int
  previousStatementId String?
  openingBalance      Decimal         @db.Decimal(14, 2)
  closingBalance      Decimal         @db.Decimal(14, 2)
  currency            String          @default("EUR")
  isGapDetected       Boolean         @default(false)
  isLocked            Boolean         @default(false)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  bankAccount         BankAccount     @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  company             Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importJob           ImportJob       @relation(fields: [importJobId], references: [id], onDelete: Cascade)
  previousStatement   Statement?      @relation("StatementChain", fields: [previousStatementId], references: [id])
  nextStatements      Statement[]     @relation("StatementChain")
  pages               StatementPage[]
  transactions        Transaction[]

  @@unique([bankAccountId, sequenceNumber, periodStart])
  @@index([companyId])
  @@index([bankAccountId])
  @@index([periodStart])
}

model StatementPage {
  id               String        @id @default(cuid())
  statementId      String
  companyId        String
  pageNumber       Int
  pageStartBalance Decimal?      @db.Decimal(14, 2)
  pageEndBalance   Decimal?      @db.Decimal(14, 2)
  status           PageStatus    @default(PENDING)
  rawText          String?
  company          Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  statement        Statement     @relation(fields: [statementId], references: [id], onDelete: Cascade)
  transactions     Transaction[]

  @@unique([statementId, pageNumber])
  @@index([companyId])
}

model Transaction {
  id          String        @id @default(cuid())
  statementId String
  pageId      String
  companyId   String
  date        DateTime
  amount      Decimal       @db.Decimal(14, 2)
  direction   TxDirection
  payeeName   String?
  description String?
  reference   String?
  iban        String?
  category    String?
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  page        StatementPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  statement   Statement     @relation(fields: [statementId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([statementId])
  @@index([pageId])
  @@index([date])
}

model SupportTicket {
  id           String                 @id @default(cuid())
  companyId    String
  createdById  String?
  assignedToId String?
  title        String
  body         String?
  status       SupportTicketStatus    @default(OPEN)
  priority     SupportTicketPriority  @default(NORMAL)
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  category     TicketCategory         @default(GENERAL)
  company      Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  messages     SupportTicketMessage[]

  @@index([companyId])
  @@index([status])
  @@index([priority])
}

model SupportTicketMessage {
  id        String        @id @default(cuid())
  ticketId  String
  authorId  String?
  body      String
  createdAt DateTime      @default(now())
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

model WebAuthnCredential {
  id           String    @id @default(cuid())
  userId       String
  credentialId String    @unique
  publicKey    String
  counter      BigInt    @default(0)
  transports   String?
  name         String?
  createdAt    DateTime  @default(now())
  lastUsedAt   DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model FiscalCertificate {
  id               String          @id @default(cuid())
  companyId        String
  environment      FiscalEnv
  provider         String          @default("DIRECT")
  certSubject      String
  certSerial       String
  certNotBefore    DateTime
  certNotAfter     DateTime
  oibExtracted     String
  certSha256       String
  encryptedP12     String
  encryptedDataKey String
  status           CertStatus      @default(PENDING)
  lastUsedAt       DateTime?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  company          Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  fiscalRequests   FiscalRequest[]

  @@unique([companyId, environment])
  @@index([companyId])
  @@index([status])
}

model FiscalRequest {
  id             String            @id @default(cuid())
  companyId      String
  certificateId  String
  invoiceId      String?
  messageType    FiscalMessageType
  status         FiscalStatus      @default(QUEUED)
  attemptCount   Int               @default(0)
  maxAttempts    Int               @default(5)
  nextRetryAt    DateTime          @default(now())
  lockedAt       DateTime?
  lockedBy       String?
  jir            String?
  zki            String?
  errorCode      String?
  errorMessage   String?
  lastHttpStatus Int?
  requestXml     String?
  signedXml      String?
  responseXml    String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  certificate    FiscalCertificate @relation(fields: [certificateId], references: [id])
  company        Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  invoice        EInvoice?         @relation(fields: [invoiceId], references: [id])

  @@unique([companyId, invoiceId, messageType])
  @@index([status, nextRetryAt])
  @@index([companyId])
  @@index([invoiceId])
}

model AIFeedback {
  id         String   @id @default(cuid())
  companyId  String
  userId     String
  entityType String
  entityId   String
  operation  String
  feedback   String
  correction Json?
  notes      String?
  createdAt  DateTime @default(now())

  @@index([companyId])
  @@index([entityType, entityId])
  @@index([operation])
}

model AIUsage {
  id         String   @id @default(cuid())
  companyId  String
  operation  String
  tokensUsed Int?
  costCents  Int?
  model      String?
  success    Boolean  @default(true)
  createdAt  DateTime @default(now())
  company    Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId, createdAt])
  @@index([companyId, operation])
}

model ArticleJob {
  id               String         @id @default(cuid())
  type             ArticleType
  status           ArticleStatus  @default(SYNTHESIZING)
  sourceUrls       String[]
  topic            String?
  currentIteration Int            @default(0)
  maxIterations    Int            @default(3)
  factSheetId      String?        @unique
  finalContentMdx  String?
  finalSlug        String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  publishedAt      DateTime?
  drafts           ArticleDraft[]
  factSheet        FactSheet?

  @@index([status])
  @@index([type])
}

model FactSheet {
  id           String        @id @default(cuid())
  jobId        String        @unique
  topic        String
  keyEntities  Json
  createdAt    DateTime      @default(now())
  claims       Claim[]
  job          ArticleJob    @relation(fields: [jobId], references: [id], onDelete: Cascade)
  sourceChunks SourceChunk[]
}

model Claim {
  id            String              @id @default(cuid())
  factSheetId   String
  statement     String
  quote         String?
  sourceUrl     String
  sourceChunkId String?
  confidence    Float
  category      String?
  factSheet     FactSheet           @relation(fields: [factSheetId], references: [id], onDelete: Cascade)
  sourceChunk   SourceChunk?        @relation(fields: [sourceChunkId], references: [id])
  verifications ClaimVerification[]

  @@index([factSheetId])
}

model SourceChunk {
  id          String    @id @default(cuid())
  factSheetId String
  sourceUrl   String
  content     String
  fetchedAt   DateTime  @default(now())
  claims      Claim[]
  factSheet   FactSheet @relation(fields: [factSheetId], references: [id], onDelete: Cascade)

  @@index([factSheetId])
}

model ArticleDraft {
  id         String           @id @default(cuid())
  jobId      String
  iteration  Int
  contentMdx String
  createdAt  DateTime         @default(now())
  job        ArticleJob       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  paragraphs DraftParagraph[]

  @@unique([jobId, iteration])
}

model DraftParagraph {
  id                 String              @id @default(cuid())
  draftId            String
  index              Int
  content            String
  isLocked           Boolean             @default(false)
  confidence         Float?
  supportingClaimIds String[]
  verifications      ClaimVerification[]
  draft              ArticleDraft        @relation(fields: [draftId], references: [id], onDelete: Cascade)

  @@unique([draftId, index])
}

model ClaimVerification {
  id              String         @id @default(cuid())
  paragraphId     String
  claimId         String
  similarityScore Float
  isSupporting    Boolean
  createdAt       DateTime       @default(now())
  claim           Claim          @relation(fields: [claimId], references: [id], onDelete: Cascade)
  paragraph       DraftParagraph @relation(fields: [paragraphId], references: [id], onDelete: Cascade)

  @@unique([paragraphId, claimId])
}

model checklist_interactions {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id        String
  company_id     String
  item_type      String    @db.VarChar(50)
  item_reference String    @db.VarChar(100)
  action         String    @db.VarChar(20)
  snoozed_until  DateTime? @db.Timestamp(6)
  created_at     DateTime? @default(now()) @db.Timestamp(6)

  @@index([item_reference], map: "checklist_interactions_reference_idx")
  @@index([user_id, company_id], map: "checklist_interactions_user_company_idx")
}

model compliance_deadlines {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title          String    @db.VarChar(200)
  description    String?
  deadline_date  DateTime  @db.Date
  deadline_type  String    @db.VarChar(50)
  applies_to     Json      @default("[\"all\"]")
  recurrence     String?   @db.VarChar(20)
  recurrence_day Int?
  source_url     String?   @db.VarChar(500)
  source_name    String?   @db.VarChar(100)
  severity       String?   @default("normal") @db.VarChar(20)
  created_at     DateTime? @default(now()) @db.Timestamptz(6)
  updated_at     DateTime? @default(now()) @db.Timestamptz(6)

  @@index([deadline_date], map: "idx_deadlines_date")
  @@index([deadline_type], map: "idx_deadlines_type")
}

model eu_transaction {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id           String
  bank_transaction_id  String?   @db.Uuid
  direction            String    @db.VarChar(20)
  counterparty_name    String?   @db.VarChar(255)
  counterparty_country String?   @db.VarChar(2)
  counterparty_vat_id  String?   @db.VarChar(20)
  transaction_date     DateTime  @db.Date
  amount               Decimal   @db.Decimal(10, 2)
  currency             String?   @default("EUR") @db.VarChar(3)
  pdv_rate             Decimal?  @default(25.00) @db.Decimal(4, 2)
  pdv_amount           Decimal?  @db.Decimal(10, 2)
  reporting_month      Int
  reporting_year       Int
  vendor_id            String?   @db.Uuid
  detection_method     String?   @db.VarChar(20)
  confidence_score     Int?
  user_confirmed       Boolean?  @default(false)
  created_at           DateTime? @default(now()) @db.Timestamp(6)

  @@index([company_id, reporting_year, reporting_month], map: "eu_transaction_reporting_idx")
}

model eu_vendor {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name_pattern     String    @db.VarChar(255)
  display_name     String    @db.VarChar(255)
  country_code     String    @db.VarChar(2)
  vendor_type      String    @db.VarChar(50)
  is_eu            Boolean?  @default(true)
  confidence_score Int?      @default(100)
  is_system        Boolean?  @default(true)
  created_at       DateTime? @default(now()) @db.Timestamp(6)

  @@index([name_pattern], map: "eu_vendor_pattern_idx")
}

model generated_form {
  id                   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id           String
  form_type            String    @db.VarChar(20)
  period_month         Int?
  period_year          Int
  format               String    @db.VarChar(10)
  file_path            String?   @db.VarChar(500)
  file_hash            String?   @db.VarChar(64)
  form_data            Json?
  submitted_to_porezna Boolean?  @default(false)
  submitted_at         DateTime? @db.Timestamp(6)
  created_at           DateTime? @default(now()) @db.Timestamp(6)
}

model news_categories {
  id                    String            @id @db.VarChar(50)
  slug                  String            @unique @db.VarChar(100)
  name_hr               String            @db.VarChar(200)
  parent_id             String?           @db.VarChar(50)
  icon                  String?           @db.VarChar(50)
  color                 String?           @db.VarChar(20)
  sort_order            Int?              @default(0)
  created_at            DateTime?         @default(now()) @db.Timestamptz(6)
  news_categories       news_categories?  @relation("news_categoriesTonews_categories", fields: [parent_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  other_news_categories news_categories[] @relation("news_categoriesTonews_categories")
  news_posts            news_posts[]

  @@index([parent_id], map: "idx_news_categories_parent")
  @@index([slug], map: "idx_news_categories_slug")
}

model news_items {
  id                  String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  source_id           String              @db.VarChar(100)
  original_title      String              @db.VarChar(500)
  original_content    String?
  source_url          String              @db.VarChar(1000)
  published_at        DateTime?           @db.Timestamptz(6)
  summary_hr          String?
  categories          Json?               @default("[]")
  relevance_score     String?             @db.VarChar(10)
  processed_at        DateTime?           @db.Timestamptz(6)
  created_at          DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at          DateTime?           @default(now()) @db.Timestamptz(6)
  fetched_at          DateTime?           @db.Timestamptz(6)
  summary_en          String?
  impact_level        String?             @db.VarChar(20)
  assigned_to_post_id String?             @db.Uuid
  image_url           String?             @db.VarChar(1000)
  image_source        String?             @db.VarChar(200)
  status              String              @default("pending") @db.VarChar(20)
  news_posts          news_posts?         @relation(fields: [assigned_to_post_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "news_items_assigned_to_post_id_news_posts_id_fk")
  news_sources        news_sources        @relation(fields: [source_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "news_items_source_id_news_sources_id_fk")
  news_post_sources   news_post_sources[]

  @@index([assigned_to_post_id], map: "idx_news_items_assigned")
  @@index([impact_level], map: "idx_news_items_impact")
  @@index([published_at], map: "idx_news_items_published")
  @@index([source_id], map: "idx_news_items_source")
  @@index([status], map: "idx_news_items_status")
  @@index([source_url], map: "idx_news_items_url")
}

model news_post_sources {
  post_id      String     @db.Uuid
  news_item_id String     @db.Uuid
  news_items   news_items @relation(fields: [news_item_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  news_posts   news_posts @relation(fields: [post_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@id([post_id, news_item_id])
  @@index([news_item_id], map: "idx_news_post_sources_item")
  @@index([post_id], map: "idx_news_post_sources_post")
}

model news_posts {
  id                     String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug                   String              @unique @db.VarChar(300)
  type                   String              @db.VarChar(20)
  title                  String              @db.VarChar(500)
  content                String
  excerpt                String?             @db.VarChar(500)
  featured_image_url     String?             @db.VarChar(1000)
  featured_image_source  String?             @db.VarChar(200)
  featured_image_caption String?             @db.VarChar(500)
  category_id            String?             @db.VarChar(50)
  tags                   Json?               @default("[]")
  impact_level           String?             @db.VarChar(20)
  ai_passes              Json?               @default("{}")
  status                 String              @default("draft") @db.VarChar(20)
  published_at           DateTime?           @db.Timestamptz(6)
  created_at             DateTime?           @default(now()) @db.Timestamptz(6)
  updated_at             DateTime?           @default(now()) @db.Timestamptz(6)
  news_items             news_items[]
  news_post_sources      news_post_sources[]
  news_categories        news_categories?    @relation(fields: [category_id], references: [id], onDelete: NoAction, onUpdate: NoAction)

  @@index([category_id], map: "idx_news_posts_category")
  @@index([impact_level], map: "idx_news_posts_impact")
  @@index([published_at], map: "idx_news_posts_published")
  @@index([slug], map: "idx_news_posts_slug")
  @@index([status], map: "idx_news_posts_status")
  @@index([type], map: "idx_news_posts_type")
}

model news_sources {
  id                   String       @id @db.VarChar(100)
  name                 String       @db.VarChar(200)
  url                  String       @db.VarChar(500)
  feed_type            String       @db.VarChar(20)
  feed_url             String?      @db.VarChar(500)
  scrape_selector      String?
  is_active            Boolean      @default(true)
  fetch_interval_hours Int          @default(24)
  last_fetched_at      DateTime?    @db.Timestamptz(6)
  created_at           DateTime?    @default(now()) @db.Timestamptz(6)
  updated_at           DateTime?    @default(now()) @db.Timestamptz(6)
  news_items           news_items[]

  @@index([is_active], map: "idx_news_sources_active")
}

model news_tags {
  id         String    @id @db.VarChar(50)
  slug       String    @unique @db.VarChar(100)
  name_hr    String    @db.VarChar(200)
  created_at DateTime? @default(now()) @db.Timestamptz(6)

  @@index([slug], map: "idx_news_tags_slug")
}

model newsletter_subscriptions {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String    @unique @db.VarChar(255)
  is_active       Boolean   @default(true)
  source          String?   @default("vijesti_sidebar") @db.VarChar(100)
  confirmed_at    DateTime? @db.Timestamptz(6)
  unsubscribed_at DateTime? @db.Timestamptz(6)
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @default(now()) @db.Timestamptz(6)

  @@index([is_active], map: "idx_newsletter_active")
  @@index([email], map: "idx_newsletter_email")
}

model notification_preference {
  id                        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id                   String
  channel                   String    @db.VarChar(20)
  enabled                   Boolean?  @default(true)
  remind_7_days             Boolean?  @default(true)
  remind_3_days             Boolean?  @default(true)
  remind_1_day              Boolean?  @default(true)
  remind_day_of             Boolean?  @default(true)
  google_calendar_connected Boolean?  @default(false)
  google_calendar_id        String?   @db.VarChar(255)
  created_at                DateTime? @default(now()) @db.Timestamp(6)
  updated_at                DateTime? @default(now()) @db.Timestamp(6)
}

model pausalni_profile {
  id               String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id       String
  has_pdv_id       Boolean?  @default(false)
  pdv_id           String?   @db.VarChar(20)
  pdv_id_since     DateTime? @db.Date
  eu_active        Boolean?  @default(false)
  hok_member_since DateTime? @db.Date
  tourism_activity Boolean?  @default(false)
  created_at       DateTime? @default(now()) @db.Timestamp(6)
  updated_at       DateTime? @default(now()) @db.Timestamp(6)

  @@index([company_id], map: "pausalni_profile_company_idx")
}

model payment_obligation {
  id                     String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  company_id             String
  obligation_type        String    @db.VarChar(50)
  period_month           Int
  period_year            Int
  amount                 Decimal   @db.Decimal(10, 2)
  due_date               DateTime  @db.Date
  status                 String    @default("PENDING") @db.VarChar(20)
  paid_date              DateTime? @db.Date
  paid_amount            Decimal?  @db.Decimal(10, 2)
  matched_transaction_id String?   @db.Uuid
  match_type             String?   @db.VarChar(20)
  notes                  String?
  created_at             DateTime? @default(now()) @db.Timestamp(6)
  updated_at             DateTime? @default(now()) @db.Timestamp(6)

  @@index([company_id, status], map: "payment_obligation_company_status_idx")
  @@index([due_date])
}

model user_guidance_preferences {
  id                 String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id            String
  level_fakturiranje String    @default("beginner") @db.VarChar(20)
  level_financije    String    @default("beginner") @db.VarChar(20)
  level_eu           String    @default("beginner") @db.VarChar(20)
  global_level       String?   @db.VarChar(20)
  email_digest       String?   @default("weekly") @db.VarChar(20)
  push_enabled       Boolean?  @default(true)
  created_at         DateTime? @default(now()) @db.Timestamp(6)
  updated_at         DateTime? @default(now()) @db.Timestamp(6)

  @@index([user_id], map: "user_guidance_preferences_user_idx")
}

enum VerificationCodeType {
  EMAIL_VERIFY
  PASSWORD_RESET
  LOGIN_VERIFY
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  ACCOUNTANT
  VIEWER
}

enum SystemRole {
  USER
  STAFF
  ADMIN
}

enum TicketCategory {
  TECHNICAL
  BILLING
  ACCOUNTING
  GENERAL
}

enum ContactType {
  CUSTOMER
  SUPPLIER
  BOTH
}

enum EInvoiceDirection {
  OUTBOUND
  INBOUND
}

enum EInvoiceStatus {
  DRAFT
  PENDING_FISCALIZATION
  FISCALIZED
  SENT
  DELIVERED
  ACCEPTED
  REJECTED
  ARCHIVED
  ERROR
}

enum InvoiceType {
  INVOICE
  E_INVOICE
  QUOTE
  PROFORMA
  CREDIT_NOTE
  DEBIT_NOTE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  LOGIN
  LOGOUT
}

enum ExpenseStatus {
  DRAFT
  PENDING
  PAID
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  OTHER
}

enum Frequency {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum ReportType {
  VAT_SUMMARY
  PROFIT_LOSS
  REVENUE_BY_CUSTOMER
  EXPENSES_BY_CATEGORY
  RECEIVABLES_AGING
  PAYABLES_AGING
  CASH_FLOW
}

enum ReportSchedule {
  NONE
  WEEKLY
  MONTHLY
  QUARTERLY
}

enum MatchStatus {
  UNMATCHED
  AUTO_MATCHED
  MANUAL_MATCHED
  IGNORED
}

enum ImportFormat {
  CSV
  XML_CAMT053
  MT940
}

enum JobStatus {
  PENDING
  PROCESSING
  VERIFIED
  NEEDS_REVIEW
  FAILED
  READY_FOR_REVIEW
  CONFIRMED
  REJECTED
}

enum TierType {
  XML
  TEXT_LLM
  VISION_LLM
}

enum DocumentType {
  BANK_STATEMENT
  INVOICE
  EXPENSE
}

enum PageStatus {
  PENDING
  VERIFIED
  NEEDS_VISION
  FAILED
}

enum TxDirection {
  INCOMING
  OUTGOING
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SupportTicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum SyncProvider {
  GOCARDLESS
  PLAID
  SALTEDGE
}

enum ConnectionStatus {
  MANUAL
  CONNECTED
  EXPIRED
}

enum TransactionSource {
  MANUAL
  AIS_SYNC
}

enum DuplicateStatus {
  PENDING
  RESOLVED
}

enum DuplicateResolution {
  KEEP_BOTH
  MERGE
  DELETE_NEW
}

enum EmailProvider {
  GMAIL
  MICROSOFT
}

enum EmailConnectionStatus {
  CONNECTED
  EXPIRED
  REVOKED
  ERROR
}

enum AttachmentStatus {
  PENDING
  IMPORTED
  SKIPPED
  FAILED
}

enum FiscalEnv {
  TEST
  PROD
}

enum CertStatus {
  PENDING
  ACTIVE
  EXPIRED
  REVOKED
}

enum FiscalStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  DEAD
}

enum FiscalMessageType {
  RACUN
  STORNO
  PROVJERA
}

enum ArticleType {
  NEWS
  GUIDE
  HOWTO
  GLOSSARY
  COMPARISON
}

enum ArticleStatus {
  SYNTHESIZING
  PLANNING
  DRAFTING
  VERIFYING
  NEEDS_REVIEW
  APPROVED
  PUBLISHED
  REJECTED
}

// =============================================================================
// REGULATORY TRUTH LAYER
// =============================================================================

enum DiscoveryEndpointType {
  SITEMAP_INDEX
  SITEMAP_ISSUE
  NEWS_LISTING
  LEGAL_ACTS
  CONSULTATIONS
  TECHNICAL_DOCS
  FORMS
  CODE_LISTS
  ANNOUNCEMENTS
  STATISTICS
}

enum DiscoveryPriority {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum ScrapeFrequency {
  EVERY_RUN
  DAILY
  TWICE_WEEKLY
  WEEKLY
  MONTHLY
}

enum ListingStrategy {
  SITEMAP_XML
  HTML_LIST
  HTML_TABLE
  PAGINATION
  DATE_FILTERED
}

enum DiscoveredItemStatus {
  PENDING
  FETCHED
  PROCESSED
  SKIPPED
  FAILED
}

enum RiskTier {
  T0  // Critical: Tax rates, legal deadlines, penalties
  T1  // High: Thresholds, contribution bases
  T2  // Medium: Procedural requirements, form fields
  T3  // Low: UI labels, help text
}

enum AgentType {
  SENTINEL
  EXTRACTOR
  COMPOSER
  REVIEWER
  RELEASER
  ARBITER
}

enum RuleStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  PUBLISHED
  DEPRECATED
  REJECTED
}

enum ConflictType {
  SOURCE_CONFLICT
  TEMPORAL_CONFLICT
  SCOPE_CONFLICT
  INTERPRETATION_CONFLICT
}

enum ConflictStatus {
  OPEN
  RESOLVED
  ESCALATED
}

enum AlertSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum AlertType {
  SOURCE_CHANGED
  SOURCE_UNAVAILABLE
  RULE_SUPERSEDED
  CONFLICT_DETECTED
  DEADLINE_APPROACHING
  CONFIDENCE_DEGRADED
  COVERAGE_GAP
}

enum GraphEdgeType {
  AMENDS
  INTERPRETS
  REQUIRES
  EXEMPTS
  DEPENDS_ON
  SUPERSEDES
}

enum AuthorityLevel {
  LAW           // Legally binding (Narodne novine)
  GUIDANCE      // Interpretation (Porezna uprava)
  PROCEDURE     // Technical execution (FINA, HZMO, HZZO)
  PRACTICE      // What passes inspections
}

enum AutomationPolicy {
  ALLOW         // Safe for full automation
  CONFIRM       // Requires user confirmation
  BLOCK         // Manual only, no automation
}

enum RuleStability {
  STABLE        // Rarely changes
  VOLATILE      // Changes frequently
}

model RegulatorySource {
  id                String    @id @default(cuid())
  slug              String    @unique  // e.g., "porezna-pausalni"
  name              String               // "Porezna uprava - Paualno oporezivanje"
  url               String
  hierarchy         Int       @default(5)  // 1=Ustav, 2=Zakon, 3=Podzakonski, 4=Pravilnik, 5=Uputa, 6=Miljenje, 7=Praksa
  fetchIntervalHours Int      @default(24)
  lastFetchedAt     DateTime?
  lastContentHash   String?
  isActive          Boolean   @default(true)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  evidence          Evidence[]
  monitoringAlerts  MonitoringAlert[]

  @@index([isActive])
  @@index([lastFetchedAt])
}

model DiscoveryEndpoint {
  id                String                @id @default(cuid())
  domain            String                // e.g., "hzzo.hr"
  path              String                // e.g., "/novosti"
  name              String                // Human-readable name
  endpointType      DiscoveryEndpointType
  priority          DiscoveryPriority
  scrapeFrequency   ScrapeFrequency
  listingStrategy   ListingStrategy
  urlPattern        String?               // Regex for extracting item URLs
  paginationPattern String?               // e.g., "?page={N}"
  lastScrapedAt     DateTime?
  lastContentHash   String?               // SHA-256 of page content
  itemCount         Int                   @default(0)
  errorCount        Int                   @default(0)
  consecutiveErrors Int                   @default(0)
  lastError         String?
  isActive          Boolean               @default(true)
  metadata          Json?                 // Additional endpoint-specific config
  createdAt         DateTime              @default(now())
  updatedAt         DateTime              @updatedAt

  discoveries       DiscoveredItem[]

  @@unique([domain, path])
  @@index([priority])
  @@index([lastScrapedAt])
}

model DiscoveredItem {
  id            String               @id @default(cuid())
  endpointId    String
  url           String
  title         String?
  publishedAt   DateTime?
  contentHash   String?
  status        DiscoveredItemStatus @default(PENDING)
  processedAt   DateTime?
  evidenceId    String?              // Link to Evidence if fetched
  errorMessage  String?
  retryCount    Int                  @default(0)
  createdAt     DateTime             @default(now())

  endpoint      DiscoveryEndpoint    @relation(fields: [endpointId], references: [id], onDelete: Cascade)

  @@unique([endpointId, url])
  @@index([status])
  @@index([publishedAt])
  @@index([evidenceId])
}

model Evidence {
  id              String   @id @default(cuid())
  sourceId        String
  fetchedAt       DateTime @default(now())
  contentHash     String
  rawContent      String   @db.Text  // Full HTML/PDF text
  contentType     String   @default("html")  // html, pdf, xml
  url             String
  hasChanged      Boolean  @default(false)
  changeSummary   String?
  deletedAt       DateTime?

  source          RegulatorySource @relation(fields: [sourceId], references: [id], onDelete: Cascade)
  sourcePointers  SourcePointer[]
  agentRuns       AgentRun[]
  extractionRejected ExtractionRejected[]

  @@unique([url, contentHash])
  @@index([sourceId])
  @@index([fetchedAt])
  @@index([contentHash])
}

model SourcePointer {
  id              String   @id @default(cuid())
  evidenceId      String
  domain          String   // pausalni, pdv, doprinosi, fiskalizacija, etc.
  valueType       String   // currency, percentage, date, threshold, text
  extractedValue  String   // Stored as string, parsed by application
  displayValue    String   // Human-readable format
  exactQuote      String   @db.Text  // Exact text from source
  contextBefore   String?  @db.Text  // Previous sentence/paragraph
  contextAfter    String?  @db.Text  // Following sentence/paragraph
  selector        String?  // CSS selector or XPath

  // Article-level anchoring
  articleNumber   String?  // e.g., "38", "12a"
  paragraphNumber String?  // e.g., "1", "2"
  lawReference    String?  // e.g., "Zakon o PDV-u (NN 73/13)"

  confidence      Float    @default(0.8)
  extractionNotes String?
  createdAt       DateTime @default(now())
  deletedAt       DateTime?

  evidence        Evidence @relation(fields: [evidenceId], references: [id], onDelete: SetNull)
  rules           RegulatoryRule[] @relation("RuleSourcePointers")

  @@index([evidenceId])
  @@index([domain])
  @@index([confidence])
  @@index([articleNumber])
}

model Concept {
  id          String   @id @default(cuid())
  slug        String   @unique  // e.g., "pausalni-obrt"
  nameHr      String
  nameEn      String?
  aliases     String[] // Alternative names
  tags        String[] // Categorization tags
  description String?  @db.Text
  parentId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  parent      Concept?  @relation("ConceptHierarchy", fields: [parentId], references: [id])
  children    Concept[] @relation("ConceptHierarchy")
  rules       RegulatoryRule[]

  @@index([parentId])
}

model RegulatoryRule {
  id                String           @id @default(cuid())
  conceptSlug       String           // e.g., "pausalni-revenue-threshold"
  conceptId         String?
  titleHr           String
  titleEn           String?
  riskTier          RiskTier
  authorityLevel    AuthorityLevel   @default(GUIDANCE)  // LAW, GUIDANCE, PROCEDURE, PRACTICE
  automationPolicy  AutomationPolicy @default(CONFIRM)   // ALLOW, CONFIRM, BLOCK
  ruleStability     RuleStability    @default(STABLE)    // STABLE, VOLATILE
  appliesWhen       String           @db.Text            // AppliesWhen DSL expression
  value             String           // The regulatory value (stored as string)
  valueType         String           // percentage, currency_hrk, currency_eur, count, date, text
  outcome           Json?            // Structured outcome (VALUE, OBLIGATION, PROCEDURE)
  explanationHr     String?          @db.Text
  explanationEn     String?          @db.Text
  effectiveFrom     DateTime
  effectiveUntil    DateTime?
  supersedesId      String?          // Previous rule this supersedes
  status            RuleStatus       @default(DRAFT)
  confidence        Float            @default(0.8)
  composerNotes     String?
  reviewerNotes     String?
  approvedBy        String?          // User ID who approved (for T0/T1)
  approvedAt        DateTime?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  concept           Concept?  @relation(fields: [conceptId], references: [id])
  supersedes        RegulatoryRule?  @relation("RuleSupersession", fields: [supersedesId], references: [id])
  supersededBy      RegulatoryRule[] @relation("RuleSupersession")
  sourcePointers    SourcePointer[]  @relation("RuleSourcePointers")
  releases          RuleRelease[]    @relation("ReleaseRules")
  conflictsA        RegulatoryConflict[] @relation("ConflictItemA")
  conflictsB        RegulatoryConflict[] @relation("ConflictItemB")
  agentRuns         AgentRun[]
  outgoingEdges     GraphEdge[] @relation("EdgeFrom")
  incomingEdges     GraphEdge[] @relation("EdgeTo")

  @@unique([conceptSlug, effectiveFrom])
  @@index([status])
  @@index([riskTier])
  @@index([conceptSlug])
  @@index([effectiveFrom])
}

model GraphEdge {
  id         String        @id @default(cuid())
  fromRuleId String
  toRuleId   String
  relation   GraphEdgeType
  validFrom  DateTime
  validTo    DateTime?
  notes      String?
  createdAt  DateTime      @default(now())

  fromRule   RegulatoryRule @relation("EdgeFrom", fields: [fromRuleId], references: [id], onDelete: Cascade)
  toRule     RegulatoryRule @relation("EdgeTo", fields: [toRuleId], references: [id], onDelete: Cascade)

  @@unique([fromRuleId, toRuleId, relation])
  @@index([fromRuleId])
  @@index([toRuleId])
}

model RuleRelease {
  id              String   @id @default(cuid())
  version         String   // semver: "1.0.0"
  releaseType     String   // major, minor, patch
  releasedAt      DateTime @default(now())
  effectiveFrom   DateTime
  contentHash     String   // SHA-256 of rule content
  changelogHr     String?  @db.Text
  changelogEn     String?  @db.Text
  approvedBy      String[] // List of approver user IDs
  auditTrail      Json?    // { sourceEvidenceCount, sourcePointerCount, reviewCount, humanApprovals }

  rules           RegulatoryRule[] @relation("ReleaseRules")

  @@unique([version])
  @@index([releasedAt])
  @@index([effectiveFrom])
}

model AgentRun {
  id              String    @id @default(cuid())
  agentType       AgentType
  status          String    @default("running")  // running, completed, failed
  input           Json      // The input provided to the agent
  output          Json?     // The output from the agent (null if failed)
  error           String?   // Error message if failed
  tokensUsed      Int?
  durationMs      Int?
  confidence      Float?
  startedAt       DateTime  @default(now())
  completedAt     DateTime?

  // Optional relations based on what the agent processed
  evidenceId      String?
  ruleId          String?

  evidence        Evidence?       @relation(fields: [evidenceId], references: [id])
  rule            RegulatoryRule? @relation(fields: [ruleId], references: [id])

  @@index([agentType])
  @@index([status])
  @@index([startedAt])
}

model RegulatoryConflict {
  id                String         @id @default(cuid())
  conflictType      ConflictType
  status            ConflictStatus @default(OPEN)
  itemAId           String?
  itemBId           String?
  description       String         @db.Text
  metadata          Json?          // Source-level conflicts store sourcePointerIds here
  resolution        Json?          // { winningItemId, strategy, rationaleHr, rationaleEn }
  confidence        Float?
  requiresHumanReview Boolean      @default(false)
  humanReviewReason String?
  resolvedBy        String?        // User ID
  resolvedAt        DateTime?
  createdAt         DateTime       @default(now())

  itemA             RegulatoryRule? @relation("ConflictItemA", fields: [itemAId], references: [id])
  itemB             RegulatoryRule? @relation("ConflictItemB", fields: [itemBId], references: [id])

  @@index([status])
  @@index([conflictType])
  @@index([createdAt])
}

model MonitoringAlert {
  id                  String        @id @default(cuid())
  severity            AlertSeverity
  type                AlertType
  affectedRuleIds     String[]
  sourceId            String?
  description         String        @db.Text
  autoAction          Json?         // { action, executed, result }
  humanActionRequired Boolean       @default(false)
  acknowledgedBy      String?
  acknowledgedAt      DateTime?
  resolvedAt          DateTime?
  createdAt           DateTime      @default(now())

  source              RegulatorySource? @relation(fields: [sourceId], references: [id])

  @@index([severity])
  @@index([type])
  @@index([sourceId])
  @@index([createdAt])
  @@index([resolvedAt])
}

// =============================================================================
// AUDIT LOG - Legal Defense Layer
// =============================================================================

model RegulatoryAuditLog {
  id           String   @id @default(cuid())
  action       String   // RULE_CREATED, RULE_APPROVED, RULE_REJECTED, CONFLICT_RESOLVED, RELEASE_PUBLISHED
  entityType   String   // RULE, CONFLICT, RELEASE, EVIDENCE
  entityId     String
  performedBy  String?  // User ID or "SYSTEM"
  performedAt  DateTime @default(now())
  metadata     Json?    // Additional context

  @@index([entityType, entityId])
  @@index([performedAt])
  @@index([action])
}

// =============================================================================
// WATCHDOG SYSTEM - Autonomous Monitoring & Health Checks
// =============================================================================

enum WatchdogSeverity {
  INFO
  WARNING
  CRITICAL
}

enum WatchdogHealthStatus {
  HEALTHY
  WARNING
  CRITICAL
}

enum WatchdogCheckType {
  STALE_SOURCE
  SCRAPER_FAILURE
  QUALITY_DEGRADATION
  PIPELINE_HEALTH
  REJECTION_RATE
}

enum WatchdogAlertType {
  STALE_SOURCE
  SCRAPER_FAILURE
  QUALITY_DEGRADATION
  PIPELINE_FAILURE
  PHASE_TIMEOUT
  HIGH_REJECTION_RATE
  AUDIT_FAIL
  AUDIT_PARTIAL
  SOURCE_SUSPENDED
}

enum AuditResult {
  PASS
  PARTIAL
  FAIL
}

model WatchdogHealth {
  id          String               @id @default(cuid())
  checkType   WatchdogCheckType
  entityId    String               // source ID, phase name, etc.
  status      WatchdogHealthStatus
  lastChecked DateTime             @default(now())
  lastHealthy DateTime?
  metric      Decimal?             @db.Decimal(10, 4)
  threshold   Decimal?             @db.Decimal(10, 4)
  message     String?

  @@unique([checkType, entityId])
  @@index([status])
  @@index([checkType])
}

model WatchdogAlert {
  id              String           @id @default(cuid())
  severity        WatchdogSeverity
  type            WatchdogAlertType
  entityId        String?
  message         String
  details         Json?
  occurredAt      DateTime         @default(now())
  acknowledgedAt  DateTime?
  acknowledgedBy  String?
  resolvedAt      DateTime?
  notifiedAt      DateTime?
  occurrenceCount Int              @default(1)

  @@index([severity])
  @@index([type])
  @@index([occurredAt])
  @@index([resolvedAt])
}

model WatchdogAudit {
  id           String      @id @default(cuid())
  runDate      DateTime    @db.Date
  auditedAt    DateTime    @default(now())
  rulesAudited Int
  rulesPassed  Int
  rulesFailed  Int
  overallScore Decimal     @db.Decimal(5, 2)
  result       AuditResult
  findings     Json
  alertsRaised String[]

  @@index([runDate])
  @@index([result])
}

// =============================================================================
// EXTRACTION REJECTED - Dead Letter Queue
// =============================================================================

model ExtractionRejected {
  id            String   @id @default(cuid())
  evidenceId    String
  rejectionType String   // e.g., "INVALID_PERCENTAGE", "QUOTE_NOT_IN_EVIDENCE", "INVALID_DATE"
  rawOutput     Json     // The raw LLM output that failed
  errorDetails  String   // Specific error message
  attemptCount  Int      @default(1)
  lastAttemptAt DateTime @default(now())
  resolvedAt    DateTime?
  createdAt     DateTime @default(now())

  evidence      Evidence @relation(fields: [evidenceId], references: [id])

  @@index([evidenceId])
  @@index([rejectionType])
  @@index([createdAt])
}
