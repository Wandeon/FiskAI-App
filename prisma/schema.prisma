generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String               @id @default(cuid())
  email               String               @unique
  name                String?
  emailVerified       DateTime?
  image               String?
  passwordHash        String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  accounts            Account[]
  companies           CompanyUser[]
  passwordResetTokens PasswordResetToken[]
  sessions            Session[]
  webAuthnCredentials WebAuthnCredential[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Company {
  id                      String    @id @default(cuid())
  name                    String
  oib                     String    @unique
  vatNumber               String?
  address                 String
  city                    String
  postalCode              String
  country                 String    @default("HR")
  email                   String?
  phone                   String?
  iban                    String?
  isVatPayer              Boolean   @default(false)
  eInvoiceProvider        String?
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  eInvoiceApiKeyEncrypted String?
  legalForm               String?
  entitlements            Json?
  featureFlags            Json?
  fiscalEnabled           Boolean   @default(false)
  fiscalEnvironment       FiscalEnv @default(PROD)
  premisesCode            String    @default("1")
  deviceCode              String    @default("1")

  // Stripe Terminal fields for POS
  stripeTerminalLocationId String? // Stripe location for reader
  stripeTerminalReaderId   String? // Connected reader ID

  // Billing/Subscription fields
  stripeCustomerId               String?   @unique
  stripeSubscriptionId           String?   @unique
  subscriptionStatus             String?   @default("trialing")
  subscriptionPlan               String?   @default("pausalni")
  subscriptionCurrentPeriodStart DateTime?
  subscriptionCurrentPeriodEnd   DateTime?
  invoiceLimit                   Int       @default(50)
  userLimit                      Int       @default(1)
  trialEndsAt                    DateTime?

  auditLogs             AuditLog[]
  bankAccounts          BankAccount[]
  businessPremises      BusinessPremises[]
  users                 CompanyUser[]
  contacts              Contact[]
  eInvoices             EInvoice[]
  expenses              Expense[]
  expenseCategories     ExpenseCategory[]
  importJobs            ImportJob[]
  invoiceSequences      InvoiceSequence[]
  paymentDevices        PaymentDevice[]
  products              Product[]
  recurringExpenses     RecurringExpense[]
  savedReports          SavedReport[]
  statements            Statement[]
  statementPages        StatementPage[]
  supportTickets        SupportTicket[]
  statementTransactions Transaction[]
  bankConnections       BankConnection[]
  potentialDuplicates   PotentialDuplicate[]
  emailConnections      EmailConnection[]
  emailImportRules      EmailImportRule[]
  emailAttachments      EmailAttachment[]
  fiscalCertificates    FiscalCertificate[]
  fiscalRequests        FiscalRequest[]
  aiUsage               AIUsage[]
}

model CompanyUser {
  id                 String    @id @default(cuid())
  userId             String
  companyId          String
  role               Role      @default(MEMBER)
  isDefault          Boolean   @default(false)
  createdAt          DateTime  @default(now())
  notificationSeenAt DateTime?
  company            Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)
  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
}

model Contact {
  id                String      @id @default(cuid())
  companyId         String
  type              ContactType
  name              String
  oib               String?
  vatNumber         String?
  address           String?
  city              String?
  postalCode        String?
  country           String      @default("HR")
  email             String?
  phone             String?
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  paymentTermsDays  Int         @default(15)
  company           Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  eInvoicesAsBuyer  EInvoice[]  @relation("EInvoiceBuyer")
  eInvoicesAsSeller EInvoice[]  @relation("EInvoiceSeller")
  expensesAsVendor  Expense[]   @relation("ExpenseVendor")

  @@unique([companyId, oib])
  @@index([companyId])
  @@index([oib])
}

model Product {
  id          String   @id @default(cuid())
  companyId   String
  name        String
  description String?
  sku         String?
  unit        String   @default("C62")
  price       Decimal  @db.Decimal(10, 2)
  vatRate     Decimal  @default(25) @db.Decimal(5, 2)
  vatCategory String   @default("S")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  company     Company  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
}

model EInvoice {
  id                String            @id @default(cuid())
  companyId         String
  direction         EInvoiceDirection
  sellerId          String?
  buyerId           String?
  invoiceNumber     String
  issueDate         DateTime
  dueDate           DateTime?
  currency          String            @default("EUR")
  buyerReference    String?
  netAmount         Decimal           @db.Decimal(10, 2)
  vatAmount         Decimal           @db.Decimal(10, 2)
  totalAmount       Decimal           @db.Decimal(10, 2)
  status            EInvoiceStatus    @default(DRAFT)
  jir               String?
  zki               String?
  fiscalizedAt      DateTime?
  fiscalStatus      String?
  operatorOib       String?
  ublXml            String?
  providerRef       String?
  providerStatus    String?
  providerError     String?
  archivedAt        DateTime?
  archiveRef        String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  sentAt            DateTime?
  receivedAt        DateTime?
  // Email tracking (via Resend webhooks)
  emailMessageId    String?
  emailDeliveredAt  DateTime?
  emailOpenedAt     DateTime?
  emailClickedAt    DateTime?
  emailBouncedAt    DateTime?
  emailBounceReason String?
  type              InvoiceType       @default(E_INVOICE)
  internalReference String?
  notes             String?
  convertedFromId   String?
  paidAt            DateTime?
  bankAccount       String?
  includeBarcode    Boolean           @default(true)
  paymentMethod     PaymentMethod? // Required for fiscalization: CASH/CARD must be fiscalized
  // Vendor payment details (for inbound invoices)
  vendorIban        String?
  vendorBankName    String?
  paymentReference  String? // poziv na broj primatelja
  paymentModel      String? // HR00, HR01, etc.
  // Source document link
  importJobId       String?           @unique
  bankTransactions  BankTransaction[]
  buyer             Contact?          @relation("EInvoiceBuyer", fields: [buyerId], references: [id])
  company           Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  convertedFrom     EInvoice?         @relation("InvoiceConversion", fields: [convertedFromId], references: [id])
  convertedTo       EInvoice[]        @relation("InvoiceConversion")
  seller            Contact?          @relation("EInvoiceSeller", fields: [sellerId], references: [id])
  importJob         ImportJob?        @relation(fields: [importJobId], references: [id])
  lines             EInvoiceLine[]
  fiscalRequests    FiscalRequest[]

  @@unique([companyId, invoiceNumber])
  @@index([companyId])
  @@index([status])
  @@index([invoiceNumber])
  @@index([direction])
  @@index([type])
  @@index([emailMessageId])
}

model EInvoiceLine {
  id          String   @id @default(cuid())
  eInvoiceId  String
  lineNumber  Int
  description String
  quantity    Decimal  @db.Decimal(10, 3)
  unit        String   @default("C62")
  unitPrice   Decimal  @db.Decimal(10, 2)
  netAmount   Decimal  @db.Decimal(10, 2)
  vatRate     Decimal  @db.Decimal(5, 2)
  vatCategory String   @default("S")
  vatAmount   Decimal  @db.Decimal(10, 2)
  eInvoice    EInvoice @relation(fields: [eInvoiceId], references: [id], onDelete: Cascade)

  @@index([eInvoiceId])
}

model AuditLog {
  id        String      @id @default(cuid())
  companyId String
  userId    String?
  action    AuditAction
  entity    String
  entityId  String
  changes   Json?
  ipAddress String?
  userAgent String?
  timestamp DateTime    @default(now())
  company   Company     @relation(fields: [companyId], references: [id])

  @@index([companyId])
  @@index([entity, entityId])
  @@index([timestamp])
}

model BusinessPremises {
  id        String            @id @default(cuid())
  companyId String
  code      Int
  name      String
  address   String?
  isDefault Boolean           @default(false)
  isActive  Boolean           @default(true)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt
  company   Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  sequences InvoiceSequence[]
  devices   PaymentDevice[]

  @@unique([companyId, code])
  @@index([companyId])
}

model PaymentDevice {
  id                 String           @id @default(cuid())
  companyId          String
  businessPremisesId String
  code               Int
  name               String
  isDefault          Boolean          @default(false)
  isActive           Boolean          @default(true)
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt
  businessPremises   BusinessPremises @relation(fields: [businessPremisesId], references: [id], onDelete: Cascade)
  company            Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([businessPremisesId, code])
  @@index([companyId])
}

model InvoiceSequence {
  id                 String           @id @default(cuid())
  companyId          String
  businessPremisesId String
  year               Int
  lastNumber         Int              @default(0)
  updatedAt          DateTime         @updatedAt
  businessPremises   BusinessPremises @relation(fields: [businessPremisesId], references: [id], onDelete: Cascade)
  company            Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([businessPremisesId, year])
  @@index([companyId])
}

model Expense {
  id               String            @id @default(cuid())
  companyId        String
  vendorId         String?
  categoryId       String
  description      String
  date             DateTime
  dueDate          DateTime?
  netAmount        Decimal           @db.Decimal(10, 2)
  vatAmount        Decimal           @db.Decimal(10, 2)
  totalAmount      Decimal           @db.Decimal(10, 2)
  vatDeductible    Boolean           @default(true)
  currency         String            @default("EUR")
  status           ExpenseStatus     @default(DRAFT)
  paymentMethod    PaymentMethod?
  paymentDate      DateTime?
  receiptUrl       String?
  notes            String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  bankTransactions BankTransaction[]
  category         ExpenseCategory   @relation(fields: [categoryId], references: [id])
  company          Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  vendor           Contact?          @relation("ExpenseVendor", fields: [vendorId], references: [id])

  @@index([companyId])
  @@index([date])
  @@index([status])
  @@index([categoryId])
}

model ExpenseCategory {
  id                   String    @id @default(cuid())
  companyId            String?
  name                 String
  code                 String
  vatDeductibleDefault Boolean   @default(true)
  isActive             Boolean   @default(true)
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt
  expenses             Expense[]
  company              Company?  @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@unique([companyId, code])
  @@index([companyId])
}

model RecurringExpense {
  id          String    @id @default(cuid())
  companyId   String
  vendorId    String?
  categoryId  String
  description String
  netAmount   Decimal   @db.Decimal(10, 2)
  vatAmount   Decimal   @db.Decimal(10, 2)
  totalAmount Decimal   @db.Decimal(10, 2)
  frequency   Frequency
  nextDate    DateTime
  endDate     DateTime?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  company     Company   @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([nextDate])
}

model SavedReport {
  id        String         @id @default(cuid())
  companyId String
  userId    String
  name      String
  type      ReportType
  filters   Json
  schedule  ReportSchedule @default(NONE)
  emailTo   String[]
  createdAt DateTime       @default(now())
  lastRunAt DateTime?
  company   Company        @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([type])
}

model BankAccount {
  id             String    @id @default(cuid())
  companyId      String
  name           String
  iban           String
  bankName       String
  currency       String    @default("EUR")
  currentBalance Decimal   @db.Decimal(12, 2)
  lastSyncAt     DateTime?
  isDefault      Boolean   @default(false)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  // Bank Sync fields
  syncProvider          SyncProvider?
  syncProviderAccountId String?
  connectionStatus      ConnectionStatus @default(MANUAL)
  connectionExpiresAt   DateTime?

  company      Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  imports      BankImport[]
  transactions BankTransaction[]
  importJobs   ImportJob[]
  statements   Statement[]
  connection   BankConnection?

  @@unique([companyId, iban])
  @@index([companyId])
  @@index([connectionStatus])
}

model BankTransaction {
  id               String      @id @default(cuid())
  companyId        String
  bankAccountId    String
  date             DateTime
  description      String
  amount           Decimal     @db.Decimal(12, 2)
  balance          Decimal     @db.Decimal(12, 2)
  reference        String?
  counterpartyName String?
  counterpartyIban String?
  matchedInvoiceId String?
  matchedExpenseId String?
  matchStatus      MatchStatus @default(UNMATCHED)
  matchedAt        DateTime?
  matchedBy        String?
  createdAt        DateTime    @default(now())
  confidenceScore  Int?

  // Bank Sync fields
  externalId String?
  source     TransactionSource @default(MANUAL)

  bankAccount    BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  matchedExpense Expense?    @relation(fields: [matchedExpenseId], references: [id])
  matchedInvoice EInvoice?   @relation(fields: [matchedInvoiceId], references: [id])

  @@index([companyId])
  @@index([bankAccountId])
  @@index([matchStatus])
  @@index([date])
  @@index([externalId])
}

model BankConnection {
  id            String @id @default(cuid())
  companyId     String
  bankAccountId String @unique

  provider             SyncProvider
  providerConnectionId String
  institutionId        String
  institutionName      String

  status       ConnectionStatus @default(MANUAL)
  authorizedAt DateTime?
  expiresAt    DateTime?
  lastError    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company     Company     @relation(fields: [companyId], references: [id], onDelete: Cascade)
  bankAccount BankAccount @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
  @@index([providerConnectionId])
}

model PotentialDuplicate {
  id        String @id @default(cuid())
  companyId String

  transactionAId String
  transactionBId String

  similarityScore Float
  reason          String

  status     DuplicateStatus      @default(PENDING)
  resolvedAt DateTime?
  resolvedBy String?
  resolution DuplicateResolution?

  createdAt DateTime @default(now())

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([status])
}

model EmailConnection {
  id           String                @id @default(cuid())
  companyId    String
  provider     EmailProvider
  emailAddress String
  status       EmailConnectionStatus @default(CONNECTED)

  accessTokenEnc  String?
  refreshTokenEnc String
  tokenExpiresAt  DateTime?
  scopes          String[]

  lastSyncAt DateTime?
  syncCursor String?
  lastError  String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  company     Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importRules EmailImportRule[]
  attachments EmailAttachment[]

  @@unique([companyId, emailAddress])
  @@index([companyId])
  @@index([status])
}

model EmailImportRule {
  id           String @id @default(cuid())
  connectionId String
  companyId    String

  senderEmail      String?
  senderDomain     String?
  subjectContains  String?
  filenameContains String?

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  connection EmailConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  company    Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([connectionId])
  @@index([companyId])
}

model EmailAttachment {
  id           String @id @default(cuid())
  companyId    String
  connectionId String

  providerMessageId    String
  providerAttachmentId String?
  contentHash          String

  receivedAt  DateTime
  senderEmail String
  subject     String
  filename    String
  mimeType    String
  sizeBytes   Int

  r2Key       String
  status      AttachmentStatus @default(PENDING)
  importJobId String?          @unique

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  connection EmailConnection @relation(fields: [connectionId], references: [id], onDelete: Cascade)
  company    Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importJob  ImportJob?      @relation(fields: [importJobId], references: [id])

  @@unique([connectionId, contentHash])
  @@index([companyId])
  @@index([connectionId])
  @@index([status])
}

model BankImport {
  id               String       @id @default(cuid())
  companyId        String
  bankAccountId    String
  fileName         String
  format           ImportFormat
  transactionCount Int
  importedAt       DateTime     @default(now())
  importedBy       String
  bankAccount      BankAccount  @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([bankAccountId])
}

model ImportJob {
  id              String           @id @default(cuid())
  companyId       String
  userId          String
  bankAccountId   String?
  fileChecksum    String
  originalName    String
  storagePath     String
  status          JobStatus        @default(PENDING)
  documentType    DocumentType?
  extractedData   Json?
  tierUsed        TierType?
  failureReason   String?
  pagesProcessed  Int              @default(0)
  pagesFailed     Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  bankAccount     BankAccount?     @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  company         Company          @relation(fields: [companyId], references: [id], onDelete: Cascade)
  statement       Statement?
  invoice         EInvoice?
  emailAttachment EmailAttachment?

  @@index([companyId])
  @@index([bankAccountId])
  @@index([status])
  @@index([bankAccountId, fileChecksum])
}

model Statement {
  id                  String          @id @default(cuid())
  importJobId         String          @unique
  companyId           String
  bankAccountId       String
  statementDate       DateTime
  periodStart         DateTime
  periodEnd           DateTime
  sequenceNumber      Int
  previousStatementId String?
  openingBalance      Decimal         @db.Decimal(14, 2)
  closingBalance      Decimal         @db.Decimal(14, 2)
  currency            String          @default("EUR")
  isGapDetected       Boolean         @default(false)
  isLocked            Boolean         @default(false)
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt
  bankAccount         BankAccount     @relation(fields: [bankAccountId], references: [id], onDelete: Cascade)
  company             Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  importJob           ImportJob       @relation(fields: [importJobId], references: [id], onDelete: Cascade)
  previousStatement   Statement?      @relation("StatementChain", fields: [previousStatementId], references: [id])
  nextStatements      Statement[]     @relation("StatementChain")
  pages               StatementPage[]
  transactions        Transaction[]

  @@unique([bankAccountId, sequenceNumber, periodStart])
  @@index([companyId])
  @@index([bankAccountId])
  @@index([periodStart])
}

model StatementPage {
  id               String        @id @default(cuid())
  statementId      String
  companyId        String
  pageNumber       Int
  pageStartBalance Decimal?      @db.Decimal(14, 2)
  pageEndBalance   Decimal?      @db.Decimal(14, 2)
  status           PageStatus    @default(PENDING)
  rawText          String?
  company          Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  statement        Statement     @relation(fields: [statementId], references: [id], onDelete: Cascade)
  transactions     Transaction[]

  @@unique([statementId, pageNumber])
  @@index([companyId])
}

model Transaction {
  id          String        @id @default(cuid())
  statementId String
  pageId      String
  companyId   String
  date        DateTime
  amount      Decimal       @db.Decimal(14, 2)
  direction   TxDirection
  payeeName   String?
  description String?
  reference   String?
  iban        String?
  category    String?
  company     Company       @relation(fields: [companyId], references: [id], onDelete: Cascade)
  page        StatementPage @relation(fields: [pageId], references: [id], onDelete: Cascade)
  statement   Statement     @relation(fields: [statementId], references: [id], onDelete: Cascade)

  @@index([companyId])
  @@index([statementId])
  @@index([pageId])
  @@index([date])
}

model SupportTicket {
  id           String                 @id @default(cuid())
  companyId    String
  createdById  String?
  assignedToId String?
  title        String
  body         String?
  status       SupportTicketStatus    @default(OPEN)
  priority     SupportTicketPriority  @default(NORMAL)
  createdAt    DateTime               @default(now())
  updatedAt    DateTime               @updatedAt
  company      Company                @relation(fields: [companyId], references: [id], onDelete: Cascade)
  messages     SupportTicketMessage[]

  @@index([companyId])
  @@index([status])
  @@index([priority])
}

model SupportTicketMessage {
  id        String        @id @default(cuid())
  ticketId  String
  authorId  String?
  body      String
  createdAt DateTime      @default(now())
  ticket    SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
}

model WebAuthnCredential {
  id           String    @id @default(cuid())
  userId       String
  credentialId String    @unique
  publicKey    String
  counter      BigInt    @default(0)
  transports   String?
  name         String?
  createdAt    DateTime  @default(now())
  lastUsedAt   DateTime?
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

enum Role {
  OWNER
  ADMIN
  MEMBER
  ACCOUNTANT
  VIEWER
}

enum ContactType {
  CUSTOMER
  SUPPLIER
  BOTH
}

enum EInvoiceDirection {
  OUTBOUND
  INBOUND
}

enum EInvoiceStatus {
  DRAFT
  PENDING_FISCALIZATION
  FISCALIZED
  SENT
  DELIVERED
  ACCEPTED
  REJECTED
  ARCHIVED
  ERROR
}

enum InvoiceType {
  INVOICE
  E_INVOICE
  QUOTE
  PROFORMA
  CREDIT_NOTE
  DEBIT_NOTE
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  LOGIN
  LOGOUT
}

enum ExpenseStatus {
  DRAFT
  PENDING
  PAID
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  TRANSFER
  OTHER
}

enum Frequency {
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

enum ReportType {
  VAT_SUMMARY
  PROFIT_LOSS
  REVENUE_BY_CUSTOMER
  EXPENSES_BY_CATEGORY
  RECEIVABLES_AGING
  PAYABLES_AGING
  CASH_FLOW
}

enum ReportSchedule {
  NONE
  WEEKLY
  MONTHLY
  QUARTERLY
}

enum MatchStatus {
  UNMATCHED
  AUTO_MATCHED
  MANUAL_MATCHED
  IGNORED
}

enum ImportFormat {
  CSV
  XML_CAMT053
  MT940
}

enum JobStatus {
  PENDING
  PROCESSING
  READY_FOR_REVIEW
  CONFIRMED
  REJECTED
  VERIFIED
  NEEDS_REVIEW
  FAILED
}

enum TierType {
  XML
  TEXT_LLM
  VISION_LLM
}

enum DocumentType {
  BANK_STATEMENT
  INVOICE
  EXPENSE
}

enum PageStatus {
  PENDING
  VERIFIED
  NEEDS_VISION
  FAILED
}

enum TxDirection {
  INCOMING
  OUTGOING
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SupportTicketPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum SyncProvider {
  GOCARDLESS
  PLAID
  SALTEDGE
}

enum ConnectionStatus {
  MANUAL
  CONNECTED
  EXPIRED
}

enum TransactionSource {
  MANUAL
  AIS_SYNC
}

enum DuplicateStatus {
  PENDING
  RESOLVED
}

enum DuplicateResolution {
  KEEP_BOTH
  MERGE
  DELETE_NEW
}

enum EmailProvider {
  GMAIL
  MICROSOFT
}

enum EmailConnectionStatus {
  CONNECTED
  EXPIRED
  REVOKED
  ERROR
}

enum AttachmentStatus {
  PENDING
  IMPORTED
  SKIPPED
  FAILED
}

enum FiscalEnv {
  TEST
  PROD
}

enum CertStatus {
  PENDING
  ACTIVE
  EXPIRED
  REVOKED
}

enum FiscalStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  DEAD
}

enum FiscalMessageType {
  RACUN
  STORNO
  PROVJERA
}

model FiscalCertificate {
  id               String     @id @default(cuid())
  companyId        String
  environment      FiscalEnv
  provider         String     @default("DIRECT")
  certSubject      String
  certSerial       String
  certNotBefore    DateTime
  certNotAfter     DateTime
  oibExtracted     String
  certSha256       String
  encryptedP12     String     @db.Text
  encryptedDataKey String
  status           CertStatus @default(PENDING)
  lastUsedAt       DateTime?
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  company        Company         @relation(fields: [companyId], references: [id], onDelete: Cascade)
  fiscalRequests FiscalRequest[]

  @@unique([companyId, environment])
  @@index([companyId])
  @@index([status])
}

model FiscalRequest {
  id             String            @id @default(cuid())
  companyId      String
  certificateId  String
  invoiceId      String?
  messageType    FiscalMessageType
  status         FiscalStatus      @default(QUEUED)
  attemptCount   Int               @default(0)
  maxAttempts    Int               @default(5)
  nextRetryAt    DateTime          @default(now())
  lockedAt       DateTime?
  lockedBy       String?
  jir            String?
  zki            String?
  errorCode      String?
  errorMessage   String?
  lastHttpStatus Int?
  requestXml     String?           @db.Text
  signedXml      String?           @db.Text
  responseXml    String?           @db.Text
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  company     Company           @relation(fields: [companyId], references: [id], onDelete: Cascade)
  certificate FiscalCertificate @relation(fields: [certificateId], references: [id])
  invoice     EInvoice?         @relation(fields: [invoiceId], references: [id])

  @@unique([companyId, invoiceId, messageType])
  @@index([status, nextRetryAt])
  @@index([companyId])
  @@index([invoiceId])
}

model AIFeedback {
  id        String @id @default(cuid())
  companyId String
  userId    String

  entityType String // "expense", "invoice", etc.
  entityId   String
  operation  String // "ocr_receipt", "category_suggestion", "ocr_invoice"

  feedback   String // "correct", "incorrect", "partial"
  correction Json? // What the correct value should be
  notes      String?

  createdAt DateTime @default(now())

  @@index([companyId])
  @@index([entityType, entityId])
  @@index([operation])
}

model AIUsage {
  id        String  @id @default(cuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  operation  String // e.g., "ocr_receipt", "extract_receipt", "extract_invoice", "categorize_expense"
  tokensUsed Int?
  costCents  Int? // Cost in cents (EUR)
  model      String? // e.g., "gpt-4o", "gpt-4o-mini"
  success    Boolean  @default(true)
  createdAt  DateTime @default(now())

  @@index([companyId, createdAt])
  @@index([companyId, operation])
}

enum ArticleType {
  NEWS
  GUIDE
  HOWTO
  GLOSSARY
  COMPARISON
}

enum ArticleStatus {
  SYNTHESIZING
  PLANNING
  DRAFTING
  VERIFYING
  NEEDS_REVIEW
  APPROVED
  PUBLISHED
  REJECTED
}

model ArticleJob {
  id     String        @id @default(cuid())
  type   ArticleType
  status ArticleStatus @default(SYNTHESIZING)

  sourceUrls String[]
  topic      String?

  currentIteration Int @default(0)
  maxIterations    Int @default(3)

  factSheetId     String? @unique
  finalContentMdx String?
  finalSlug       String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  factSheet FactSheet?
  drafts    ArticleDraft[]

  @@index([status])
  @@index([type])
}

model FactSheet {
  id    String @id @default(cuid())
  jobId String @unique

  topic       String
  keyEntities Json

  createdAt DateTime @default(now())

  job          ArticleJob?   @relation(fields: [jobId], references: [id], onDelete: Cascade)
  claims       Claim[]
  sourceChunks SourceChunk[]
}

model Claim {
  id          String @id @default(cuid())
  factSheetId String

  statement     String
  quote         String?
  sourceUrl     String
  sourceChunkId String?

  confidence Float
  category   String?

  factSheet     FactSheet           @relation(fields: [factSheetId], references: [id], onDelete: Cascade)
  sourceChunk   SourceChunk?        @relation(fields: [sourceChunkId], references: [id])
  verifications ClaimVerification[]

  @@index([factSheetId])
}

model SourceChunk {
  id          String @id @default(cuid())
  factSheetId String

  sourceUrl String
  content   String
  // embedding vector(768) added via raw SQL migration

  fetchedAt DateTime @default(now())

  factSheet FactSheet @relation(fields: [factSheetId], references: [id], onDelete: Cascade)
  claims    Claim[]

  @@index([factSheetId])
}

model ArticleDraft {
  id        String @id @default(cuid())
  jobId     String
  iteration Int

  contentMdx String

  createdAt DateTime @default(now())

  job        ArticleJob       @relation(fields: [jobId], references: [id], onDelete: Cascade)
  paragraphs DraftParagraph[]

  @@unique([jobId, iteration])
}

model DraftParagraph {
  id      String @id @default(cuid())
  draftId String

  index    Int
  content  String
  isLocked Boolean @default(false)

  confidence         Float?
  supportingClaimIds String[]

  draft         ArticleDraft        @relation(fields: [draftId], references: [id], onDelete: Cascade)
  verifications ClaimVerification[]

  @@unique([draftId, index])
}

model ClaimVerification {
  id          String @id @default(cuid())
  paragraphId String
  claimId     String

  similarityScore Float
  isSupporting    Boolean

  createdAt DateTime @default(now())

  paragraph DraftParagraph @relation(fields: [paragraphId], references: [id], onDelete: Cascade)
  claim     Claim          @relation(fields: [claimId], references: [id], onDelete: Cascade)

  @@unique([paragraphId, claimId])
}
