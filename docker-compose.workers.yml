# docker-compose.workers.yml
# Extends base docker-compose.yml with worker services

services:
  redis:
    image: redis:7-alpine
    container_name: fiskai-redis
    restart: unless-stopped
    volumes:
      - fiskai_redis_data:/data
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy noeviction
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - default
      - coolify
    # Port mapping removed - Redis accessible only within Docker network
    # Workers connect via internal hostname: redis://fiskai-redis:6379
    # For external access (e.g., queue-status.ts), use: docker exec fiskai-redis redis-cli
    # or SSH tunnel: ssh -L 6379:localhost:6379 admin@server

  # Bull Board disabled - no ARM64 support
  # Use scripts/queue-status.ts for monitoring instead
  # bull-board:
  #   image: deadly0/bull-board:latest
  #   container_name: fiskai-bull-board
  #   restart: unless-stopped
  #   environment:
  #     - REDIS_HOST=redis
  #     - REDIS_PORT=6379
  #     - BULL_PREFIX=fiskai
  #   ports:
  #     - "3003:3000"
  #   depends_on:
  #     redis:
  #       condition: service_healthy
  #   networks:
  #     - default
  #     - coolify

  # Worker services
  worker-orchestrator:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-orchestrator
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/orchestrator.worker.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      - DATABASE_URL=${DATABASE_URL}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL}
      - WORKER_TYPE=orchestrator
      - WORKER_CONCURRENCY=1
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
      - coolify

  worker-sentinel:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-sentinel
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/sentinel.worker.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      - DATABASE_URL=${DATABASE_URL}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL}
      - WORKER_TYPE=sentinel
      - WORKER_CONCURRENCY=1
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
      - coolify

  worker-extractor:
    build:
      context: .
      dockerfile: Dockerfile.worker
    # No container_name when using replicas
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/extractor.worker.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      - DATABASE_URL=${DATABASE_URL}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL}
      - OLLAMA_ENDPOINT=${OLLAMA_ENDPOINT}
      - OLLAMA_API_KEY=${OLLAMA_API_KEY}
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      - WORKER_TYPE=extractor
      - WORKER_CONCURRENCY=2
    volumes:
      - ./src:/app/src:ro
    depends_on:
      redis:
        condition: service_healthy
    deploy:
      replicas: 2
    networks:
      - default
      - coolify

  worker-ocr:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-ocr
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/ocr.worker.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      - DATABASE_URL=${DATABASE_URL}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL}
      - OLLAMA_ENDPOINT=${OLLAMA_ENDPOINT}
      - OLLAMA_API_KEY=${OLLAMA_API_KEY}
      - OLLAMA_VISION_MODEL=${OLLAMA_VISION_MODEL:-llama3.2-vision}
      - WORKER_TYPE=ocr
      - WORKER_CONCURRENCY=1
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
      - coolify

  worker-composer:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-composer
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/composer.worker.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      - DATABASE_URL=${DATABASE_URL}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL}
      - OLLAMA_ENDPOINT=${OLLAMA_ENDPOINT}
      - OLLAMA_API_KEY=${OLLAMA_API_KEY}
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      - WORKER_TYPE=composer
      - WORKER_CONCURRENCY=1
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
      - coolify

  worker-reviewer:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-reviewer
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/reviewer.worker.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      - DATABASE_URL=${DATABASE_URL}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL}
      - OLLAMA_ENDPOINT=${OLLAMA_ENDPOINT}
      - OLLAMA_API_KEY=${OLLAMA_API_KEY}
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      - WORKER_TYPE=reviewer
      - WORKER_CONCURRENCY=1
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
      - coolify

  worker-scheduler:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-scheduler
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/scheduler.service.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      - WATCHDOG_TIMEZONE=Europe/Zagreb
      - WORKER_TYPE=scheduler
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
      - coolify

  worker-releaser:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-releaser
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/releaser.worker.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      - DATABASE_URL=${DATABASE_URL}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL}
      - WORKER_TYPE=releaser
      - WORKER_CONCURRENCY=1
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
      - coolify

  worker-arbiter:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-arbiter
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/arbiter.worker.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      - DATABASE_URL=${DATABASE_URL}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL}
      - OLLAMA_ENDPOINT=${OLLAMA_ENDPOINT}
      - OLLAMA_API_KEY=${OLLAMA_API_KEY}
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      - WORKER_TYPE=arbiter
      - WORKER_CONCURRENCY=1
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
      - coolify

  # Layer B: Continuous 24/7 queue draining
  worker-continuous-drainer:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-continuous-drainer
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/continuous-drainer.worker.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      # DATABASE_URL uses environment variable - set in .env or shell
      # Format: postgresql://user:password@host:port/database?schema=public
      - DATABASE_URL=${DATABASE_URL:-postgresql://fiskai:${DB_PASSWORD}@fiskai-db:5432/fiskai?schema=public}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL:-postgresql://fiskai:${DB_PASSWORD}@fiskai-db:5432/fiskai?schema=regulatory}
      - WORKER_TYPE=continuous-drainer
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
      - coolify

  # Content Sync: Patches MDX frontmatter with RTL rule changes
  worker-content-sync:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-content-sync
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/content-sync.worker.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      - DATABASE_URL=${DATABASE_URL:-postgresql://fiskai:${DB_PASSWORD}@fiskai-db:5432/fiskai?schema=public}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL:-postgresql://fiskai:${DB_PASSWORD}@fiskai-db:5432/fiskai?schema=regulatory}
      - WORKER_TYPE=content-sync
      - WORKER_CONCURRENCY=1
      # GitHub token for PR creation
      - GITHUB_TOKEN=${GITHUB_TOKEN}
    volumes:
      # Mount content directory for patching (read-write)
      - ./content:/app/content:rw
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
      - coolify
    deploy:
      resources:
        limits:
          memory: 512M

  # Article Agent: Generates articles from news/RTL events
  worker-article:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-article
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/article.worker.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      - DATABASE_URL=${DATABASE_URL:-postgresql://fiskai:${DB_PASSWORD}@fiskai-db:5432/fiskai?schema=public}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL:-postgresql://fiskai:${DB_PASSWORD}@fiskai-db:5432/fiskai?schema=regulatory}
      - OLLAMA_ENDPOINT=${OLLAMA_ENDPOINT}
      - OLLAMA_API_KEY=${OLLAMA_API_KEY}
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      - WORKER_TYPE=article
      - WORKER_CONCURRENCY=1
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
      - coolify
    deploy:
      resources:
        limits:
          memory: 1G

  # Evidence Embedding Worker: Generates embeddings for Evidence records (semantic duplicate detection)
  # Uses local Ollama (ArtemiPC via Tailscale) for embeddings - separate from extraction
  worker-evidence-embedding:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-evidence-embedding
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/evidence-embedding.worker.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      - DATABASE_URL=${DATABASE_URL:-postgresql://fiskai:${DB_PASSWORD}@fiskai-db:5432/fiskai?schema=public}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL:-postgresql://fiskai:${DB_PASSWORD}@fiskai-db:5432/fiskai?schema=regulatory}
      # Embedding-specific Ollama config (local Ollama via Tailscale)
      - OLLAMA_EMBED_ENDPOINT=${OLLAMA_EMBED_ENDPOINT}
      - OLLAMA_EMBED_API_KEY=${OLLAMA_EMBED_API_KEY}
      - OLLAMA_EMBED_MODEL=${OLLAMA_EMBED_MODEL:-nomic-embed-text}
      - OLLAMA_EMBED_DIMS=${OLLAMA_EMBED_DIMS:-768}
      - WORKER_TYPE=evidence-embedding
      - WORKER_CONCURRENCY=2
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
      - coolify
    deploy:
      resources:
        limits:
          memory: 512M

  # Embedding Worker: Generates embeddings for published rules
  # Uses local Ollama (ArtemiPC via Tailscale) for embeddings - separate from extraction
  worker-embedding:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-embedding
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/regulatory-truth/workers/embedding.worker.ts"]
    environment:
      - NODE_ENV=production
      - REDIS_URL=redis://fiskai-redis:6379
      - DATABASE_URL=${DATABASE_URL:-postgresql://fiskai:${DB_PASSWORD}@fiskai-db:5432/fiskai?schema=public}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL:-postgresql://fiskai:${DB_PASSWORD}@fiskai-db:5432/fiskai?schema=regulatory}
      # Embedding-specific Ollama config (local Ollama via Tailscale)
      - OLLAMA_EMBED_ENDPOINT=${OLLAMA_EMBED_ENDPOINT}
      - OLLAMA_EMBED_API_KEY=${OLLAMA_EMBED_API_KEY}
      - OLLAMA_EMBED_MODEL=${OLLAMA_EMBED_MODEL:-nomic-embed-text}
      - OLLAMA_EMBED_DIMS=${OLLAMA_EMBED_DIMS:-768}
      - WORKER_TYPE=embedding
      - WORKER_CONCURRENCY=2
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - default
      - coolify
    deploy:
      resources:
        limits:
          memory: 512M

  # E-Invoice Inbound Poller: Polls ePoslovanje for incoming invoices
  # Note: One instance per company (configured via COMPANY_ID)
  worker-einvoice-inbound:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: fiskai-worker-einvoice-inbound
    restart: unless-stopped
    command: ["npx", "tsx", "src/lib/e-invoice/workers/eposlovanje-inbound-poller.worker.ts"]
    environment:
      - NODE_ENV=production
      - DATABASE_URL=${DATABASE_URL:-postgresql://fiskai:${DB_PASSWORD}@fiskai-db:5432/fiskai?schema=public}
      - REGULATORY_DATABASE_URL=${REGULATORY_DATABASE_URL:-postgresql://fiskai:${DB_PASSWORD}@fiskai-db:5432/fiskai?schema=regulatory}
      - EPOSLOVANJE_API_BASE=${EPOSLOVANJE_API_BASE}
      - EPOSLOVANJE_API_KEY=${EPOSLOVANJE_API_KEY}
      - COMPANY_ID=${EINVOICE_COMPANY_ID}
      - POLL_INTERVAL_MS=${EINVOICE_POLL_INTERVAL_MS:-300000}
      - MAX_WINDOW_DAYS=${EINVOICE_MAX_WINDOW_DAYS:-7}
      - WORKER_TYPE=einvoice-inbound
    networks:
      - default
      - coolify
    deploy:
      resources:
        limits:
          memory: 256M

volumes:
  fiskai_redis_data:

networks:
  coolify:
    external: true
