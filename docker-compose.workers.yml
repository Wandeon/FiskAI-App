# docker-compose.workers.yml
# Production worker services using pre-built GHCR images
#
# Usage:
#   IMAGE_TAG=abc123 docker compose -f docker-compose.workers.yml up -d
#
# For local development with builds, use:
#   docker compose -f docker-compose.workers.yml -f docker-compose.workers.dev.yml up -d
#
# IMAGE_TAG can be:
#   - A commit SHA (e.g., abc123def) - recommended for production
#   - "latest" - convenience tag, updated on each main push
#   - A full digest (e.g., sha256:abc...) - most reproducible

x-worker-common: &worker-common
  image: ghcr.io/wandeon/fiskai-worker:${IMAGE_TAG:-latest}
  restart: unless-stopped
  networks:
    - default
    - coolify
  depends_on:
    redis:
      condition: service_healthy
  environment: &worker-env
    NODE_ENV: production
    REDIS_URL: redis://fiskai-redis:6379
    DATABASE_URL: ${DATABASE_URL}
    REGULATORY_DATABASE_URL: ${REGULATORY_DATABASE_URL}
    # RTL Pipeline mode: PHASE_D | LEGACY | OFF (default: OFF for safety)
    RTL_PIPELINE_MODE: ${RTL_PIPELINE_MODE:-OFF}

x-worker-ocr: &worker-ocr
  image: ghcr.io/wandeon/fiskai-worker-ocr:${IMAGE_TAG:-latest}
  restart: unless-stopped
  networks:
    - default
    - coolify
  depends_on:
    redis:
      condition: service_healthy
  environment:
    <<: *worker-env

services:
  redis:
    image: redis:7-alpine
    container_name: fiskai-redis
    restart: unless-stopped
    volumes:
      - fiskai_redis_data:/data
    command: redis-server --appendonly yes --maxmemory 2gb --maxmemory-policy noeviction
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - default
      - coolify

  worker-orchestrator:
    <<: *worker-common
    container_name: fiskai-worker-orchestrator
    command: ["node", "dist/workers/lib/regulatory-truth/workers/orchestrator.worker.js"]
    environment:
      <<: *worker-env
      WORKER_TYPE: orchestrator
      WORKER_CONCURRENCY: 1
    deploy:
      resources:
        limits:
          memory: 512M

  worker-sentinel:
    <<: *worker-common
    container_name: fiskai-worker-sentinel
    command: ["node", "dist/workers/lib/regulatory-truth/workers/sentinel.worker.js"]
    environment:
      <<: *worker-env
      OLLAMA_EMBED_ENDPOINT: ${OLLAMA_EMBED_ENDPOINT}
      OLLAMA_EMBED_API_KEY: ${OLLAMA_EMBED_API_KEY}
      OLLAMA_EMBED_MODEL: ${OLLAMA_EMBED_MODEL:-nomic-embed-text}
      OLLAMA_EMBED_DIMS: ${OLLAMA_EMBED_DIMS:-768}
      WORKER_TYPE: sentinel
      WORKER_CONCURRENCY: 1
    deploy:
      resources:
        limits:
          memory: 512M

  worker-extractor:
    <<: *worker-common
    container_name: fiskai-worker-extractor
    command: ["node", "dist/workers/lib/regulatory-truth/workers/extractor.worker.js"]
    environment:
      <<: *worker-env
      OLLAMA_EXTRACT_ENDPOINT: ${OLLAMA_EXTRACT_ENDPOINT}
      OLLAMA_EXTRACT_API_KEY: ${OLLAMA_EXTRACT_API_KEY}
      OLLAMA_EXTRACT_MODEL: ${OLLAMA_EXTRACT_MODEL}
      WORKER_TYPE: extractor
      WORKER_CONCURRENCY: 1
    deploy:
      resources:
        limits:
          memory: 1G

  worker-ocr:
    <<: *worker-ocr
    container_name: fiskai-worker-ocr
    command: ["node", "dist/workers/lib/regulatory-truth/workers/ocr.worker.js"]
    environment:
      <<: *worker-env
      OLLAMA_ENDPOINT: ${OLLAMA_ENDPOINT}
      OLLAMA_API_KEY: ${OLLAMA_API_KEY}
      OLLAMA_VISION_MODEL: ${OLLAMA_VISION_MODEL:-llama3.2-vision}
      WORKER_TYPE: ocr
      WORKER_CONCURRENCY: 1
    deploy:
      resources:
        limits:
          memory: 2G

  worker-composer:
    <<: *worker-common
    container_name: fiskai-worker-composer
    command: ["node", "dist/workers/lib/regulatory-truth/workers/composer.worker.js"]
    environment:
      <<: *worker-env
      OLLAMA_ENDPOINT: ${OLLAMA_ENDPOINT}
      OLLAMA_API_KEY: ${OLLAMA_API_KEY}
      OLLAMA_MODEL: ${OLLAMA_MODEL}
      WORKER_TYPE: composer
      WORKER_CONCURRENCY: 1
    deploy:
      resources:
        limits:
          memory: 512M

  # PHASE-D: Apply worker - handles persistence of composer proposals
  # Creates SourcePointers from CandidateFacts and RegulatoryRules
  worker-apply:
    <<: *worker-common
    container_name: fiskai-worker-apply
    command: ["node", "dist/workers/lib/regulatory-truth/workers/apply.worker.js"]
    environment:
      <<: *worker-env
      WORKER_TYPE: apply
      WORKER_CONCURRENCY: 1
    deploy:
      resources:
        limits:
          memory: 512M

  worker-reviewer:
    <<: *worker-common
    container_name: fiskai-worker-reviewer
    command: ["node", "dist/workers/lib/regulatory-truth/workers/reviewer.worker.js"]
    environment:
      <<: *worker-env
      OLLAMA_ENDPOINT: ${OLLAMA_ENDPOINT}
      OLLAMA_API_KEY: ${OLLAMA_API_KEY}
      OLLAMA_MODEL: ${OLLAMA_MODEL}
      WORKER_TYPE: reviewer
      WORKER_CONCURRENCY: 1
    deploy:
      resources:
        limits:
          memory: 512M

  worker-scheduler:
    <<: *worker-common
    container_name: fiskai-worker-scheduler
    command: ["node", "dist/workers/lib/regulatory-truth/workers/scheduler.service.js"]
    environment:
      <<: *worker-env
      WATCHDOG_TIMEZONE: Europe/Zagreb
      WORKER_TYPE: scheduler
    deploy:
      resources:
        limits:
          memory: 512M

  worker-releaser:
    <<: *worker-common
    container_name: fiskai-worker-releaser
    command: ["node", "dist/workers/lib/regulatory-truth/workers/releaser.worker.js"]
    environment:
      <<: *worker-env
      WORKER_TYPE: releaser
      WORKER_CONCURRENCY: 1
    deploy:
      resources:
        limits:
          memory: 512M

  worker-arbiter:
    <<: *worker-common
    container_name: fiskai-worker-arbiter
    command: ["node", "dist/workers/lib/regulatory-truth/workers/arbiter.worker.js"]
    environment:
      <<: *worker-env
      OLLAMA_ENDPOINT: ${OLLAMA_ENDPOINT}
      OLLAMA_API_KEY: ${OLLAMA_API_KEY}
      OLLAMA_MODEL: ${OLLAMA_MODEL}
      WORKER_TYPE: arbiter
      WORKER_CONCURRENCY: 1
    deploy:
      resources:
        limits:
          memory: 512M

  worker-continuous-drainer:
    <<: *worker-common
    container_name: fiskai-worker-continuous-drainer
    command: ["node", "dist/workers/lib/regulatory-truth/workers/continuous-drainer.worker.js"]
    environment:
      <<: *worker-env
      OLLAMA_EMBED_ENDPOINT: ${OLLAMA_EMBED_ENDPOINT}
      OLLAMA_EMBED_API_KEY: ${OLLAMA_EMBED_API_KEY}
      OLLAMA_EMBED_MODEL: ${OLLAMA_EMBED_MODEL:-nomic-embed-text}
      OLLAMA_EMBED_DIMS: ${OLLAMA_EMBED_DIMS:-768}
      WORKER_TYPE: continuous-drainer
    deploy:
      resources:
        limits:
          memory: 256M

  worker-content-sync:
    <<: *worker-common
    container_name: fiskai-worker-content-sync
    command: ["node", "dist/workers/lib/regulatory-truth/workers/content-sync.worker.js"]
    environment:
      <<: *worker-env
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      WORKER_TYPE: content-sync
      WORKER_CONCURRENCY: 1
    volumes:
      - ./content:/app/content:rw
    deploy:
      resources:
        limits:
          memory: 512M

  worker-article:
    <<: *worker-common
    container_name: fiskai-worker-article
    command: ["node", "dist/workers/lib/regulatory-truth/workers/article.worker.js"]
    environment:
      <<: *worker-env
      OLLAMA_ENDPOINT: ${OLLAMA_ENDPOINT}
      OLLAMA_API_KEY: ${OLLAMA_API_KEY}
      OLLAMA_MODEL: ${OLLAMA_MODEL}
      WORKER_TYPE: article
      WORKER_CONCURRENCY: 1
    deploy:
      resources:
        limits:
          memory: 1G

  worker-evidence-embedding:
    <<: *worker-common
    container_name: fiskai-worker-evidence-embedding
    command: ["node", "dist/workers/lib/regulatory-truth/workers/evidence-embedding.worker.js"]
    environment:
      <<: *worker-env
      OLLAMA_EMBED_ENDPOINT: ${OLLAMA_EMBED_ENDPOINT}
      OLLAMA_EMBED_API_KEY: ${OLLAMA_EMBED_API_KEY}
      OLLAMA_EMBED_MODEL: ${OLLAMA_EMBED_MODEL:-nomic-embed-text}
      OLLAMA_EMBED_DIMS: ${OLLAMA_EMBED_DIMS:-768}
      WORKER_TYPE: evidence-embedding
      WORKER_CONCURRENCY: 2
    deploy:
      resources:
        limits:
          memory: 512M

  worker-embedding:
    <<: *worker-common
    container_name: fiskai-worker-embedding
    command: ["node", "dist/workers/lib/regulatory-truth/workers/embedding.worker.js"]
    environment:
      <<: *worker-env
      OLLAMA_EMBED_ENDPOINT: ${OLLAMA_EMBED_ENDPOINT}
      OLLAMA_EMBED_API_KEY: ${OLLAMA_EMBED_API_KEY}
      OLLAMA_EMBED_MODEL: ${OLLAMA_EMBED_MODEL:-nomic-embed-text}
      OLLAMA_EMBED_DIMS: ${OLLAMA_EMBED_DIMS:-768}
      WORKER_TYPE: embedding
      WORKER_CONCURRENCY: 2
    deploy:
      resources:
        limits:
          memory: 512M

  worker-einvoice-inbound:
    <<: *worker-common
    container_name: fiskai-worker-einvoice-inbound
    command: ["node", "dist/workers/lib/e-invoice/workers/eposlovanje-inbound-poller.worker.js"]
    environment:
      <<: *worker-env
      # Multi-tenant mode: discovers all companies with EINVOICE_EPOSLOVANJE IntegrationAccount
      # Set COMPANY_ID to enable single-tenant mode (backwards compatible)
      # COMPANY_ID: ${EINVOICE_COMPANY_ID}
      USE_INTEGRATION_ACCOUNT_INBOUND: "true"
      POLL_INTERVAL_MS: ${EINVOICE_POLL_INTERVAL_MS:-300000}
      TENANT_DELAY_MS: ${EINVOICE_TENANT_DELAY_MS:-10000}
      MAX_WINDOW_DAYS: ${EINVOICE_MAX_WINDOW_DAYS:-7}
      WORKER_TYPE: einvoice-inbound
    deploy:
      resources:
        limits:
          memory: 256M

volumes:
  fiskai_redis_data:

networks:
  coolify:
    external: true
