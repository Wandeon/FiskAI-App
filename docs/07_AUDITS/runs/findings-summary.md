# Audit Findings Summary

## accessibility-audit.md

- **Incorrect document language** — Severity: Medium. Evidence: – Root layout sets `<html lang="en">` (`src/app/layout.tsx:12-18`) even though the UI copy is Croatian (`Prijava`, `Novi E-Račun`, etc.). Screen readers will mispronounce labels. Set `lang="hr"` (or make it dynamic per locale) to ensure proper pronunciation and spell checking.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Inputs lack ARIA metadata** — Severity: Medium. Evidence: – `Input` component (`src/components/ui/input.tsx:8-22`) toggles border color for errors but never sets `aria-invalid`, nor links the helper text via `aria-describedby`. Keyboard/screen-reader users therefore do not know which fields are invalid. Add these attributes and ensure ids are unique so error text is announced.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Unlabeled select element** — Severity: Medium. Evidence: – The buyer dropdown on the new invoice form (`src/app/(dashboard)/e-invoices/new/page.tsx:101-118`) renders `<label className="text-sm font-medium">` without `htmlFor`, and the `<select>` lacks an `id`, so assistive tech cannot map the label. Assign ids and connect labels to form controls.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Tables missing captions and scope** — Severity: Medium. Evidence: – The invoices table (`src/app/(dashboard)/e-invoices/page.tsx:31-88`) lacks a `<caption>` describing the data and does not set `scope="col"`/`scope="row"`. This makes navigating rows/columns difficult for screen readers. Add a caption summarizing the table contents and scope attributes for headers.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Status indicators rely on color alone** — Severity: Medium. Evidence: – Dashboard status chips (e.g., PDV obveznik) use green/yellow icons only (`src/app/(dashboard)/dashboard/page.tsx:62-83`). Users with color-vision deficiencies cannot distinguish states. Include text labels (e.g., “PDV: Da/Ne”) and consider adding icons with distinct shapes or patterns.. Owner: TBD. Due: TBD. Affected invariants: None.
- **No focus management or announcements after actions** — Severity: Medium. Evidence: – Forms such as login/register (`src/app/(auth)/login/page.tsx:37-85`) render inline error divs without `role="alert"`/`aria-live`, so errors are not announced. Add live regions and move focus to the first invalid field on submit failure.. Owner: TBD. Due: TBD. Affected invariants: None.
## code-quality-architecture.md

- **Client pages import server actions directly** — Severity: Medium. Evidence: – `src/app/(dashboard)/e-invoices/new/page.tsx:12-55` imports `getContacts` from the `"use server"` action module and calls it inside `useEffect`. This bypasses server-component data fetching patterns, couples the client bundle to server-only code, and makes error/loading states hard to manage. Replace with server-side data fetching (load contacts in the page’s async component and pass via props) or expose a typed API route/React Query hook.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Money totals computed with floating-point math before persisting** — Severity: Medium. Evidence: – `src/app/actions/e-invoice.ts:24-49` multiplies JS numbers to derive `netAmount`, `vatAmount`, and `totalAmount`, then wraps them with `new Decimal(...)`. Floating-point accumulation can yield rounding errors for currency (e.g., 0.1+0.2). Use Prisma `Decimal` (or a helper) for all arithmetic to ensure exact cents throughout.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Redundant auth/company lookups** — Severity: Medium. Evidence: – In `src/app/(dashboard)/e-invoices/page.tsx:7-20` the page already runs `requireAuth`/`requireCompany`, but it then calls `getEInvoices()` (`src/app/actions/e-invoice.ts:145-165`), which repeats the same checks, resulting in duplicate DB queries per request. Either accept a `companyId` parameter or move the query logic directly into the page component to avoid N+1 lookups and simplify tracing.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Server actions return unstructured errors** — Severity: Medium. Evidence: – Actions such as `register`, `login`, `createCompany`, and `createEInvoice` (`src/app/actions/*.ts`) return `{ error: string }` without error codes or field metadata (except one schema flatten). This makes client UX inconsistent and hampers logging/observability. Introduce a shared result type (`{ ok: boolean; message; code; details }`) and centralize logging so both UI and telemetry stay consistent.. Owner: TBD. Due: TBD. Affected invariants: None.
- **No shared validation/masking utilities for repeated business fields** — Severity: Medium. Evidence: – OIB, IBAN, phone, and VAT logic are replicated in multiple forms (`src/app/(dashboard)/onboarding/page.tsx`, `src/app/(dashboard)/e-invoices/new/page.tsx`). Extract reusable input components with built-in formatting, validation hooks, and help text to reduce duplication and future bugs.. Owner: TBD. Due: TBD. Affected invariants: None.
## devex-ci-audit.md

- **No continuous integration** — Severity: Medium. Evidence: – Repository lacks any `.github/workflows` (or other CI config), so linting, type checks, Prisma migrations, and tests are never enforced before deployment. Introduce a pipeline (GitHub Actions or equivalent) that runs `npm run lint`, `npm run build`, and database migrations on every PR/main push.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Missing `.env.example` / secrets guidance** — Severity: Medium. Evidence: – The repo includes `.env` and `.env.local` with real connection strings but no sanitized template for contributors. Provide a checked-in `.env.example` with placeholder values plus documentation on how to configure Coolify/production secrets, and keep sensitive files out of git.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Dockerfile not optimized for target platform** — Severity: Medium. Evidence: – Production runs on ARM64 (per docs) yet `Dockerfile` starts from `FROM node:20-alpine` without `--platform=linux/arm64`. Builds performed on x86 may emit incompatible binaries. Pin the platform in each stage or use `node:20-alpine@sha256:...` multi-arch images, and document the expectation.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Compose file doubles as production manifest** — Severity: Medium. Evidence: – `docker-compose.yml:1-40` mixes local dev and prod concerns (hard-coded secrets, `NEXTAUTH_URL=https://erp.metrica.hr`). Maintain separate `docker-compose.dev.yml` and `docker-compose.prod.yml` (or .env overrides) so developers can run the stack safely without touching prod credentials.. Owner: TBD. Due: TBD. Affected invariants: None.
- **No task automation for Prisma** — Severity: Medium. Evidence: – There is no script for `prisma migrate deploy`/`prisma db push` in `package.json`. Add npm scripts (e.g., `"db:migrate"`) and document migration flow to keep schema changes synchronized.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Observability missing** — Severity: Medium. Evidence: – There are no logging/monitoring hooks (no structured logger, no health metrics, no uptime checks). Instrument the app via middleware or integrate Coolify monitoring, and ensure logs are structured for ingestion.. Owner: TBD. Due: TBD. Affected invariants: None.
## domain-data-audit.md

- **Invoice numbers not unique per company** — Severity: High. Evidence: – `prisma/schema.prisma:183-240` defines `invoiceNumber` with only a standalone index (`@@index([invoiceNumber])`). Two tenants could end up sharing the same number, and even within one company duplicate numbers are possible, leading to accounting/fiscalization errors. Add a composite constraint `@@unique([companyId, invoiceNumber])` to ensure numbering sequences remain unique per tenant.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Cross-tenant contact references allowed** — Severity: High. Evidence: – `createEInvoice` (`src/app/actions/e-invoice.ts:12-78`) accepts any `buyerId`/`sellerId` without verifying they belong to the caller’s company. Coupled with eager inclusion of `buyer` data in list/detail queries (`src/app/actions/e-invoice.ts:152-182`), a malicious user can attach another tenant’s contact and expose their PII. Enforce ownership checks before writing (e.g., `await db.contact.findFirst({ where: { id: buyerId, companyId: company.id } })`) or add Prisma middleware to inject `companyId` conditions automatically.. Owner: TBD. Due: TBD. Affected invariants: None.
- **No constraint on default company per user** — Severity: Medium. Evidence: – `CompanyUser` (`prisma/schema.prisma:97-112`) tracks `isDefault` but nothing prevents multiple entries being true for the same user. Server logic (`src/app/actions/company.ts:137-145`) tries to reset flags before switching, yet concurrent requests can still yield two defaults. Add a partial unique index (Prisma: `@@unique([userId], map: "unique_default_company", where: isDefault = true)`) or enforce via database constraint to keep tenant routing deterministic.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Sensitive provider credentials stored in plaintext** — Severity: High. Evidence: – Company settings store `eInvoiceApiKey` directly in the `Company` row (`prisma/schema.prisma:83-95`) and server action `updateCompanySettings` (`src/app/actions/company.ts:88-118`) writes the raw string. Beyond security concerns, this violates regulatory requirements for handling fiscalization keys. Introduce field-level encryption (e.g., libsodium) or move provider credentials into a dedicated secrets table with transparent encryption/decryption.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Contact data lacks per-company uniqueness** — Severity: High. Evidence: – `Contact.oib` is indexed but not constrained per tenant (`prisma/schema.prisma:126-151`). A supplier entered by two colleagues could produce duplicates, breaking invoice validation. Add `@@unique([companyId, oib])` (with nullable handling) and provide deduplication logic in the UI.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Products & contacts unmanaged yet referenced** — Severity: Medium. Evidence: – While Prisma models for `Product` and `Contact` exist, there are no API routes/UI for enforcing mandatory fields (e.g., VAT category, OIB). Until those modules ship, invoices can reference incomplete contacts, undermining compliance. Define minimum data requirements and validation flows before enabling outbound e-invoicing for production users.. Owner: TBD. Due: TBD. Affected invariants: None.
## performance-audit.md

- **Extra round-trips for contacts data** — Severity: Medium. Evidence: – The new invoice page fetches contacts from the client bundle (`src/app/(dashboard)/e-invoices/new/page.tsx:12-55`). Every render triggers a server action call over the network, even though the page is an async server component that could preload contacts once during SSR. Move the query to the server side (or expose a paginated API) to avoid duplicate fetches and improve TTFB.. Owner: TBD. Due: TBD. Affected invariants: None.
- **No pagination or limits on invoice queries** — Severity: Medium. Evidence: – `getEInvoices` (`src/app/actions/e-invoice.ts:145-165`) returns every invoice for a company with full relations. As data grows, responses will balloon and tank both DB and rendering performance. Introduce pagination (cursor/limit), expose filters in the UI, and default to, e.g., the last 50 records.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Loading unused relations** — Severity: Medium. Evidence: – The list view only needs buyer name, totals, and status, yet `getEInvoices` includes `seller` and every `line` (`src/app/actions/e-invoice.ts:158-162`). Pulling all child rows on every list request increases query time and JSON size. Use `select` to fetch only the fields needed for each screen, and lazily load line items when opening an invoice detail.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Duplicated authentication queries** — Severity: Medium. Evidence: – Pages such as `src/app/(dashboard)/e-invoices/page.tsx` already resolve `requireAuth`/`requireCompany`, but calling `getEInvoices()` performs the same checks again (`src/app/actions/e-invoice.ts:145-165`). This results in two DB hits and two session validations per request. Refactor helpers to accept the resolved `companyId` to cut redundant work.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Build image misses production dependency pruning** — Severity: Medium. Evidence: – Dockerfile copies the entire `node_modules` directory from the build stage into the runner (`Dockerfile:14-48`) without running `npm prune --production` or using `npm ci --omit=dev`, so the final image ships devDependencies and wastes memory. Prune dev packages before copying to the runtime layer to shrink startup footprint.. Owner: TBD. Due: TBD. Affected invariants: None.
## security-audit.md

- **Hard-coded production secrets committed to git** — Severity: High. Evidence: `docker-compose.yml` embeds live Postgres credentials and `NEXTAUTH_SECRET` (lines 6-33). Anyone with repo access gets DB user/pass and JWT secret, enabling database compromise and forging Auth.js sessions. **Remediation:** Move all secrets to environment/secret management (Coolify, host env, etc.), remove from git, and rotate every leaked credential immediately.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Host header poisoning via `AUTH_TRUST_HOST=true`** — Severity: High. Evidence: Compose file sets `AUTH_TRUST_HOST=true` while exposing the container on `0.0.0.0:3002`. Auth.js will trust arbitrary `Host` headers, so direct hits to the VPS IP can forge callbacks/cookies for attacker domains → account takeover/open redirects. **Remediation:** Drop the flag and rely on `NEXTAUTH_URL`, or restrict network so only Cloudflare/front proxy can reach the app.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Provider API keys stored/returned in plaintext** — Severity: High. Evidence: `Company.eInvoiceApiKey` is plain string storage (schema lines 84-85) and `updateCompanySettings` writes raw data without encryption or access scoping. Brokers/DB readers can steal e-invoice provider keys and submit invoices on behalf of clients. **Remediation:** Encrypt at rest (KMS/lib­sodium), never echo the raw key back, and rotate any existing keys.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Cross-tenant contact disclosure in e-invoice creation** — Severity: High. Evidence: `createEInvoice` trusts `buyerId` from the client without checking tenant ownership; later `getEInvoices`/`getEInvoice` eagerly include the buyer relation. Attackers can reference another company’s contact ID to view their full PII. **Remediation:** Verify `buyerId`/`sellerId` belong to the caller’s company prior to create/update and add Prisma-level constraints/middleware enforcing `companyId` filters across relations.. Owner: TBD. Due: TBD. Affected invariants: None.
## ui-ux-audit.md

- **Company context missing:** — Severity: Medium. Evidence: Header only shows the logged-in email (`src/components/layout/header.tsx:16-24`), so users juggling multiple companies cannot tell which tenant is active nor switch it. Add a prominent company switcher (with search) plus status badges (e.g., onboarding complete, provider connected).. Owner: TBD. Due: TBD. Affected invariants: None.
- **Action feedback:** — Severity: Medium. Evidence: No global toast system, meaning server-action successes/errors (e.g., save contact, send invoice) rely on inline form state. Introduce a non-blocking notification layer so every action provides immediate confirmation and nudge toward the next logical step.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Navigation depth:** — Severity: Medium. Evidence: Sidebar (`src/components/layout/sidebar.tsx:7-34`) advertises Contacts/Products/Settings but there are no implemented routes yet. Until modules exist, hide or disable the links to avoid dead ends; when enabled, indicate unread items/tasks counts.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Responsive behavior:** — Severity: Medium. Evidence: Shell is desktop-focused (fixed `w-64` sidebar, static header). Implement collapsible navigation for tablets/phones and keep primary CTAs accessible via floating action buttons (FAB) on smaller devices.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Missing recovery path:** — Severity: Medium. Evidence: Login form stops at email/password (`src/app/(auth)/login/page.tsx:37-78`); there is no “Forgot password?”, passwordless option, or contact support link. Add recovery CTA beneath the password field and surface help text when Auth errors occur repeatedly.. Owner: TBD. Due: TBD. Affected invariants: None.
- **SSO discoverability:** — Severity: Medium. Evidence: Google provider is configured server-side, yet no button appears in the UI. Show branded OAuth buttons alongside the native form to shorten onboarding for busy founders.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Context & trust:** — Severity: Medium. Evidence: Provide short marketing copy (security badges, privacy note, support contact) inside the card so new accountants feel safe entering credentials.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Registration guardrails:** — Severity: Medium. Evidence: Register form lacks password strength meter or inline explanation of the policy defined in `registerSchema` (`src/app/(auth)/register/page.tsx:79-100`). Display the rules upfront, validate in real time, and require acceptance of terms/GDPR consent before submission.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Single long form without progress:** — Severity: Medium. Evidence: The onboarding screen is a blank form (`src/app/(dashboard)/onboarding/page.tsx:44-152`) that does not explain why data is needed. Split into a progressive 3-step wizard (Company basics → Tax info → Communication + preview) with a progress bar and autosave.. Owner: TBD. Due: TBD. Affected invariants: None.
- **No contextual helpers:** — Severity: Medium. Evidence: Fields such as OIB, VAT payer, IBAN provide no helper text or validation on blur. Add inline tooltips (e.g., “OIB must be 11 digits; we’ll verify checksum automatically”), masked inputs, and prefill ISO country code.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Lack of next-step guidance:** — Severity: Medium. Evidence: After submission the user is redirected silently to `/dashboard`. Show a confirmation screen summarizing the new company, highlighting next tasks (“Add your first contact”, “Connect e-invoice provider”).. Owner: TBD. Due: TBD. Affected invariants: None.
- **Invite teammates:** — Severity: Medium. Evidence: Most SMEs collaborate with accountants; offer an optional “Invite accountant/email” input so they can add colleagues before leaving onboarding.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Limited insight:** — Severity: Medium. Evidence: Dashboard only displays two counts and the OIB (`src/app/(dashboard)/dashboard/page.tsx:27-60`). Expand into cards that answer “What requires my attention right now?”: drafts awaiting send, invoices overdue, contacts missing OIB, setup checklists.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Action shortcuts:** — Severity: Medium. Evidence: Provide CTA buttons on cards (e.g., “Create invoice”, “Add contact”) and show provider connection status with direct links to configure missing items (`company.eInvoiceProvider` data at lines 62-83).. Owner: TBD. Due: TBD. Affected invariants: None.
- **Timeline & announcements:** — Severity: Medium. Evidence: Include a chronological feed (recent invoices, contact updates, system alerts) plus contextual education (e.g., Fiskalizacija 2.0 deadlines) so the page becomes the nerve center.. Owner: TBD. Due: TBD. Affected invariants: None.
- **No filtering/search:** — Severity: Medium. Evidence: `getEInvoices()` powers a static table (`src/app/(dashboard)/e-invoices/page.tsx:22-91`). Introduce filters for direction, status, date range and a search box for invoice number/customer. Persist selections per user.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Missing batch actions:** — Severity: Medium. Evidence: Users often need to send, export or archive multiple invoices. Add checkboxes, bulk action bar, and quick actions per row (Send, Download PDF/XML, Duplicate).. Owner: TBD. Due: TBD. Affected invariants: None.
- **Status explanation:** — Severity: Medium. Evidence: Badges currently show raw enums (e.g., `PENDING_FISCALIZATION`). Provide human labels, tooltips describing what each status means, and highlight blockers (e.g., “Needs provider connection”).. Owner: TBD. Due: TBD. Affected invariants: None.
- **Empty state onboarding:** — Severity: Medium. Evidence: Replace the generic empty message (lines 24-30) with an illustrated panel explaining the 3 steps to issue an invoice and link to add contacts/products before starting.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Needs stepwise structure:** — Severity: Medium. Evidence: Long form mixes buyer info, numbering, lines, totals in one scroll (`src/app/(dashboard)/e-invoices/new/page.tsx:87-254`). Convert to a multi-step composer with a sticky summary sidebar so users always see totals, due date, and payment instructions.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Buyer selection pain:** — Severity: Medium. Evidence: Dropdown simply lists contacts alphabetically (lines 101-118). Add typeahead search, contact preview (address, VAT status), and inline “Add new contact” modal so users stay in flow.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Missing numbering helpers:** — Severity: Medium. Evidence: `invoiceNumber` input is blank (121-125). Auto-suggest the next sequence per company (e.g., `2025-0004`), allow templates, and warn before duplicates.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Line item ergonomics:** — Severity: Medium. Evidence: Manually typing units and VAT each time is error-prone (lines 149-223). Integrate products/services picker with price/vat defaults, allow drag-and-drop ordering, and show inline calculations (net/vat per row) plus comments/discounts fields.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Payment & attachments:** — Severity: Medium. Evidence: There’s no section to add payment instructions, notes, or attachments even though XML may include them. Provide fields for payment terms, bank accounts (pull from company), custom footer, and file uploads for supporting documents.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Send/preview flow:** — Severity: Medium. Evidence: Submitting always saves as draft (`Button` label lines 244-250). Offer secondary actions: preview PDF/XML, “Save & send now”, and “Schedule send”. After success, show an explicit confirmation page with next steps (download, share link).. Owner: TBD. Due: TBD. Affected invariants: None.
- **Guided tours + checklists:** — Severity: Medium. Evidence: Provide contextual tours (hotspots) for first-time users and persistent “Getting started” checklist to surface required steps.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Feedback loops:** — Severity: Medium. Evidence: Confirm every destructive action with modal summaries, show toasts/snackbars for success/error, and log events for future analytics.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Accessibility & localization:** — Severity: Medium. Evidence: Ensure all form controls have labels/help text, focus states, keyboard support, and support bilingual labels (HR + EN) with a language switcher.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Data visualization:** — Severity: Medium. Evidence: For accountants, charts of revenue, VAT owed, and cash due dates quickly answer “what’s next?” Build small multiples on the dashboard once enough data exists.. Owner: TBD. Due: TBD. Affected invariants: None.
- **Mobile parity:** — Severity: Medium. Evidence: Prioritize responsive redesign so invoice approval and quick actions can be completed on phones (e.g., bottom navigation, simplified tables with accordions).. Owner: TBD. Due: TBD. Affected invariants: None.
