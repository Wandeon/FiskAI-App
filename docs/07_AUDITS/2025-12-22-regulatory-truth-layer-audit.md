# Regulatory Truth Layer Audit

Date: 2025-12-22
Version: 1.0
Scope: Regulatory truth layer backend (agents, pipeline, storage, APIs, monitoring, audit logging)

## Executive Summary

Overall assessment: NOT production ready.

Go/No-Go recommendation: NO-GO until Critical and High findings are addressed.

Key themes:

- Rules cannot be applied reliably because the AppliesWhen DSL used in prompts does not match the evaluator implementation.
- Conflict handling is broken for composer-created conflicts, making arbitration and admin resolution impossible for those cases.
- Manual triggers are placeholders and do not execute pipeline phases, limiting operational control and recovery.
- Audit trails are incomplete for evidence creation, conflict creation, and human approvals, reducing legal defensibility.

Severity counts:

- Critical: 3
- High: 5
- Medium: 7
- Low: 1

## Scope and Methodology

- Static code review of regulatory-truth layer, agents, utilities, database schema, and API routes.
- Focus on functional correctness, data integrity, auditability, and operational readiness.
- No live data or production infrastructure access.
- No external source crawling or manual legal validation against Croatian regulations.

### Tests Executed

- npx tsx --test src/lib/regulatory-truth/**tests**/arbiter.test.ts (pass)
- npx tsx --test src/lib/regulatory-truth/**tests**/sentinel.test.ts (pass)
- npm run build (pass)

## Detailed Findings

### Critical Findings

CRIT-01: AppliesWhen DSL mismatch breaks rule evaluation

- Evidence:
  - Prompt DSL uses function-style expressions (date_range, entity_type) in src/lib/regulatory-truth/prompts/index.ts:121-129.
  - Evaluator expects JSON with op/args in src/lib/regulatory-truth/dsl/applies-when.ts:14-55 and parseAppliesWhen at src/lib/regulatory-truth/dsl/applies-when.ts:217-219.
  - Evaluation endpoint skips invalid predicates at src/app/api/rules/evaluate/route.ts:66-81.
- Impact: Rules generated by the Composer are not parseable, causing evaluates to silently skip rules, leading to incorrect or empty answers.
- Recommendation: Align prompts and storage format to the JSON schema used by the evaluator, add server-side validation of appliesWhen before saving rules, and reject or repair invalid rules during review.

CRIT-02: Composer creates conflicts without itemA/itemB references

- Evidence:
  - Composer creates conflicts without itemAId/itemBId in src/lib/regulatory-truth/agents/composer.ts:90-105.
  - Arbiter requires itemA/itemB in src/lib/regulatory-truth/agents/arbiter.ts:94-143.
  - Admin conflict resolve route validates itemAId/itemBId in src/app/api/admin/regulatory-truth/conflicts/[id]/resolve/route.ts:24-60.
- Impact: Conflicts created by Composer are unresolvable by Arbiter or Admin, blocking the pipeline and leaving unresolved conflicts.
- Recommendation: Populate itemAId/itemBId for all conflicts or introduce a second conflict type for pointer-based conflicts and update Arbiter/Admin to handle it.

CRIT-03: Manual pipeline triggers are placeholders

- Evidence:
  - Trigger route only creates AgentRun records and does not execute Sentinel in src/app/api/admin/regulatory-truth/trigger/route.ts:25-52.
  - Source check route does the same in src/app/api/admin/regulatory-truth/sources/[id]/check/route.ts:35-55.
- Impact: Operators cannot actually trigger or recover pipeline phases, preventing operational control and incident response.
- Recommendation: Connect trigger endpoints to actual job execution (queue jobs or invoke pipeline functions) and return real job IDs tied to execution.

### High Findings

HIGH-01: Updates to existing URLs are not re-fetched

- Evidence:
  - DiscoveredItem unique constraint prevents re-creating same URL at prisma/schema.prisma:1702-1719.
  - fetchDiscoveredItems only processes PENDING items in src/lib/regulatory-truth/agents/sentinel.ts:252-264.
- Impact: If a document changes at the same URL, the update may never be detected or re-processed, resulting in stale rules.
- Recommendation: Add a re-fetch mechanism for existing URLs based on content hash change, or store per-item lastFetchedAt and re-queue items on schedule.

HIGH-02: Monitoring script calls runSentinel with wrong signature

- Evidence:
  - monitor.ts calls runSentinel(sourceId) in src/lib/regulatory-truth/scripts/monitor.ts:125-133.
  - runSentinel signature expects a DiscoveryPriority, not a sourceId, in src/lib/regulatory-truth/agents/sentinel.ts:184-186.
- Impact: Monitoring script fails or behaves incorrectly; pipeline automation is unreliable.
- Recommendation: Update monitoring to use the correct agent signature or create a source-specific sentinel function.

HIGH-03: Audit log incomplete for critical events

- Evidence:
  - Audit action types include EVIDENCE_FETCHED and CONFLICT_CREATED in src/lib/regulatory-truth/utils/audit-log.ts:5-14.
  - Evidence creation does not log audit events in src/lib/regulatory-truth/agents/sentinel.ts:306-315.
  - Composer conflict creation does not log audit events in src/lib/regulatory-truth/agents/composer.ts:90-105.
  - Admin approvals and rejections do not log audit events in src/app/api/admin/regulatory-truth/rules/[id]/approve/route.ts:35-43 and src/app/api/admin/regulatory-truth/rules/[id]/reject/route.ts:41-53.
- Impact: Legal defensibility is weakened; chain-of-custody and human decisions are not fully traceable.
- Recommendation: Add audit logging for evidence fetch, conflict creation, and human approvals/rejections, and include actor metadata.

HIGH-04: Agent runner has no timeout or abort

- Evidence:
  - Ollama fetch lacks AbortController or timeout in src/lib/regulatory-truth/agents/runner.ts:113-133.
- Impact: Hung requests can leave AgentRun records in running state indefinitely, stalling pipelines and masking failures.
- Recommendation: Add timeouts and abort logic per run, and mark stale runs as failed with reason.

HIGH-05: Release approvals are sourced from LLM output

- Evidence:
  - Release approvedBy uses releaseOutput.approved_by in src/lib/regulatory-truth/agents/releaser.ts:221-232.
  - RuleRelease.approvedBy is intended to store user IDs in prisma/schema.prisma:1859.
- Impact: Audit integrity risk; releases can claim approvals that never happened.
- Recommendation: Populate approvedBy from actual human approvals in the database, not LLM output.

### Medium Findings

MED-01: Authority derivation ignores RegulatorySource.hierarchy

- Evidence:
  - deriveAuthorityLevel uses slug heuristics in src/lib/regulatory-truth/utils/authority.ts:9-35.
  - RegulatorySource.hierarchy exists in prisma/schema.prisma:1653-1659.
- Impact: Authority level can be misclassified, impacting conflict resolution precedence.
- Recommendation: Derive authority from the source hierarchy field or map hierarchies to AuthorityLevel explicitly.

MED-02: Rate limiter configuration is partially unused

- Evidence:
  - maxRequestsPerMinute and maxConcurrentRequests are defined but not enforced in src/lib/regulatory-truth/utils/rate-limiter.ts:3-21, 46-71.
- Impact: Rate limit compliance is weaker than configured; higher risk of being blocked by sources.
- Recommendation: Implement request counters and concurrency gates tied to the configured limits.

MED-03: Evaluate endpoint loads all published rules

- Evidence:
  - findMany without pagination in src/app/api/rules/evaluate/route.ts:32-50.
- Impact: Performance degradation as rules scale to thousands.
- Recommendation: Filter rules by date and metadata in DB, or stream evaluation in batches.

MED-04: AppliesWhen between allows both gte/lte missing

- Evidence:
  - gte and lte are optional in schema and evaluation in src/lib/regulatory-truth/dsl/applies-when.ts:41-46 and 174-183.
- Impact: A between predicate with no bounds returns true for any numeric value, creating overly broad applicability.
- Recommendation: Require at least one bound or treat missing bounds as invalid.

MED-05: Evidence change metadata not captured

- Evidence:
  - Evidence has hasChanged/changeSummary fields in prisma/schema.prisma:1724-1733.
  - Evidence creation does not set those fields in src/lib/regulatory-truth/agents/sentinel.ts:306-315.
- Impact: Change detection metadata is lost, weakening audit traceability.
- Recommendation: Populate hasChanged and changeSummary when evidence is created from changes.

MED-06: Search endpoint lacks enum validation

- Evidence:
  - riskTier and authorityLevel are accepted as strings in src/app/api/rules/search/route.ts:36-43.
  - riskTier and authorityLevel are enums in prisma/schema.prisma:1786-1794.
- Impact: Invalid values can cause Prisma errors or unbounded queries.
- Recommendation: Validate query params against enums and return 400 on invalid input.

MED-07: AI provider mismatch vs audit request

- Evidence:
  - Agent runner uses OLLAMA\_\* environment variables in src/lib/regulatory-truth/agents/runner.ts:12-14.
  - Audit request specifies Anthropic Claude as provider.
- Impact: Documentation drift and operational confusion; risk of incorrect security or cost assumptions.
- Recommendation: Align documentation to actual provider or implement the Anthropic client as described.

### Low Findings

LOW-01: Invalid appliesWhen predicates are skipped silently

- Evidence:
  - Evaluation route logs a warning and skips invalid predicates in src/app/api/rules/evaluate/route.ts:78-81.
- Impact: Users receive incomplete results without explicit error feedback.
- Recommendation: Return a list of invalid rule IDs or a warning field in API response.

## Readiness and Roadmap

Immediate fixes before production:

1. Align AppliesWhen DSL and enforce validation at rule creation and review.
2. Fix conflict creation to include item references or handle pointer-based conflicts in Arbiter/Admin.
3. Make manual trigger endpoints actually execute pipeline phases.
4. Implement audit logging for evidence, conflicts, and human actions.
5. Add timeouts and aborts to Agent runner.

Near-term improvements:

- Add re-fetch logic for updated documents at the same URL.
- Enforce rate limits and concurrency caps.
- Improve evaluate query scalability.
- Validate all API input enums.

## Risk Registry

See docs/07_AUDITS/2025-12-22-regulatory-truth-layer-risk-registry.csv for full registry.

## Open Questions

- What is the intended AppliesWhen DSL format (JSON vs function-style)?
- Should conflicts be created at the SourcePointer level or Rule level, and how should Arbiter handle each type?
- What is the required human approval process (single approver vs multi-approver) for releases?
- Do we need a formal retention policy for Evidence and DiscoveredItems?

## Appendix: Files Reviewed

- src/lib/regulatory-truth/agents/\*
- src/lib/regulatory-truth/dsl/\*
- src/lib/regulatory-truth/utils/\*
- src/lib/regulatory-truth/scripts/\*
- src/app/api/rules/\*
- src/app/api/admin/regulatory-truth/\*
- prisma/schema.prisma
