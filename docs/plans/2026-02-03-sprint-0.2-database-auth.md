# Sprint 0.2: Database & Auth Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Connect to PostgreSQL, run migrations, and implement user authentication by reusing the existing amazing auth UI/UX from the old FiskAI repo.

**Architecture:** NextAuth v5 with Prisma adapter. Multi-step glassmorphic auth flow with OTP verification. Reuse GlassCard, FloatingOrbs, OTPInput, AnimatedButton components from old repo.

**Tech Stack:** Next.js 16, NextAuth v5, Prisma 7, tRPC 11, PostgreSQL 16, bcrypt, Zod, Framer Motion

---

## Prerequisites

- Database running on VPS-01 (100.64.123.81:5434)
- Tailscale connected
- Old repo available at `/home/admin/FiskAI`

---

## Task 1: Install Dependencies

**Files:**
- Modify: `apps/web/package.json`

**Step 1: Install auth and animation dependencies**

```bash
cd /home/admin/FiskAI-App
pnpm --filter @fiskai/web add next-auth@beta @auth/prisma-adapter bcryptjs framer-motion
pnpm --filter @fiskai/web add -D @types/bcryptjs
```

**Step 2: Install all workspace dependencies**

```bash
pnpm install
```

**Step 3: Commit**

```bash
git add -A
git commit -m "chore(deps): add NextAuth, bcrypt, framer-motion"
```

---

## Task 2: Configure Environment Variables

**Step 1: Create .env files**

```bash
cp .env.example .env
cp apps/web/.env.example apps/web/.env.local
```

**Step 2: Update .env.local with actual values**

```env
DATABASE_URL="postgresql://fiskai:PASSWORD@100.64.123.81:5434/fiskai_fresh?schema=public"
NEXTAUTH_URL="http://localhost:3000"
NEXTAUTH_SECRET="<run: openssl rand -hex 32>"
NEXT_PUBLIC_APP_URL="http://localhost:3000"
NEXT_PUBLIC_APP_NAME="FiskAI"
RESEND_API_KEY="<your-resend-key>"
RESEND_FROM_EMAIL="FiskAI <noreply@fiskai.hr>"
```

**Step 3: Test database connectivity**

```bash
PGPASSWORD=PASSWORD psql -h 100.64.123.81 -p 5434 -U fiskai -d fiskai_fresh -c "SELECT 1"
```

---

## Task 3: Run Prisma Migration

**Step 1: Generate Prisma client**

```bash
pnpm db:generate
```

**Step 2: Run migration**

```bash
cd packages/db
DATABASE_URL="postgresql://fiskai:PASSWORD@100.64.123.81:5434/fiskai_fresh?schema=public" npx prisma migrate dev --name init
```

**Step 3: Commit migration**

```bash
git add packages/db/prisma/migrations
git commit -m "chore(db): add initial migration"
```

---

## Task 4: Add VerificationToken Model to Schema

**Files:**
- Modify: `packages/db/prisma/schema/auth.prisma`

**Step 1: Add VerificationCode model for OTP**

Add to `packages/db/prisma/schema/auth.prisma`:
```prisma
model VerificationCode {
  id        String   @id @default(cuid())
  email     String
  code      String   // Hashed 6-digit code
  type      CodeType
  attempts  Int      @default(0)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@unique([email, type])
  @@index([email])
  @@map("verification_codes")
}

enum CodeType {
  EMAIL_VERIFY
  LOGIN_VERIFY
  PASSWORD_RESET
}
```

**Step 2: Run migration**

```bash
cd packages/db
DATABASE_URL="..." npx prisma migrate dev --name add_verification_codes
```

**Step 3: Commit**

```bash
git add packages/db/prisma
git commit -m "feat(db): add VerificationCode model for OTP"
```

---

## Task 5: Copy Auth UI Components from Old Repo

**Source:** `/home/admin/FiskAI/src/components/auth/`
**Destination:** `/home/admin/FiskAI-App/apps/web/src/components/auth/`

**Step 1: Create directory and copy components**

```bash
mkdir -p apps/web/src/components/auth/steps

# Copy main components
cp /home/admin/FiskAI/src/components/auth/GlassCard.tsx apps/web/src/components/auth/
cp /home/admin/FiskAI/src/components/auth/AnimatedButton.tsx apps/web/src/components/auth/
cp /home/admin/FiskAI/src/components/auth/FloatingOrbs.tsx apps/web/src/components/auth/
cp /home/admin/FiskAI/src/components/auth/OTPInput.tsx apps/web/src/components/auth/
cp /home/admin/FiskAI/src/components/auth/AuthFlow.tsx apps/web/src/components/auth/
cp /home/admin/FiskAI/src/components/auth/useAuthFlow.ts apps/web/src/components/auth/

# Copy step components
cp /home/admin/FiskAI/src/components/auth/steps/IdentifyStep.tsx apps/web/src/components/auth/steps/
cp /home/admin/FiskAI/src/components/auth/steps/AuthenticateStep.tsx apps/web/src/components/auth/steps/
cp /home/admin/FiskAI/src/components/auth/steps/RegisterStep.tsx apps/web/src/components/auth/steps/
cp /home/admin/FiskAI/src/components/auth/steps/VerifyStep.tsx apps/web/src/components/auth/steps/
cp /home/admin/FiskAI/src/components/auth/steps/ResetStep.tsx apps/web/src/components/auth/steps/
cp /home/admin/FiskAI/src/components/auth/steps/SuccessStep.tsx apps/web/src/components/auth/steps/
```

**Step 2: Create index export**

Create `apps/web/src/components/auth/index.ts`:
```typescript
export { AuthFlow } from './AuthFlow';
export { GlassCard } from './GlassCard';
export { AnimatedButton } from './AnimatedButton';
export { FloatingOrbs } from './FloatingOrbs';
export { OTPInput } from './OTPInput';
export { useAuthFlow } from './useAuthFlow';
```

**Step 3: Commit**

```bash
git add apps/web/src/components/auth
git commit -m "feat(auth): copy glassmorphic auth components from old repo"
```

---

## Task 6: Copy Auth Validation Schemas

**Source:** `/home/admin/FiskAI/src/lib/validations/auth.ts`

**Step 1: Copy validation file**

```bash
mkdir -p apps/web/src/lib/validations
cp /home/admin/FiskAI/src/lib/validations/auth.ts apps/web/src/lib/validations/
```

**Step 2: Commit**

```bash
git add apps/web/src/lib/validations
git commit -m "feat(auth): add auth validation schemas"
```

---

## Task 7: Create NextAuth Configuration

**Files:**
- Create: `apps/web/src/lib/auth.ts`

**Step 1: Copy and adapt auth config**

Copy from `/home/admin/FiskAI/src/lib/auth.ts` and adapt:
- Remove passkey provider (not needed for MVP)
- Remove Google provider (can add later)
- Update imports for new package structure
- Simplify cookie config for development

**Step 2: Create the file**

Create `apps/web/src/lib/auth.ts`:
```typescript
import NextAuth from 'next-auth';
import Credentials from 'next-auth/providers/credentials';
import { PrismaAdapter } from '@auth/prisma-adapter';
import bcrypt from 'bcryptjs';
import jwt from 'jsonwebtoken';
import { db } from '@fiskai/db';

export const { handlers, signIn, signOut, auth } = NextAuth({
  adapter: PrismaAdapter(db),
  session: { strategy: 'jwt' },
  pages: {
    signIn: '/auth',
  },
  providers: [
    Credentials({
      name: 'credentials',
      credentials: {
        email: { type: 'email' },
        password: { type: 'password' },
      },
      async authorize(credentials) {
        if (!credentials?.email) return null;

        const email = credentials.email as string;
        const password = credentials.password as string;

        // Check for JWT token (from OTP verification)
        if (password?.startsWith('eyJ')) {
          try {
            const decoded = jwt.verify(
              password,
              process.env.NEXTAUTH_SECRET!
            ) as { email: string; userId: string };

            if (decoded.email !== email) return null;

            const user = await db.user.findUnique({
              where: { id: decoded.userId },
            });

            if (!user) return null;

            return {
              id: user.id,
              email: user.email,
              name: user.name,
            };
          } catch {
            return null;
          }
        }

        // Standard password authentication
        const user = await db.user.findUnique({
          where: { email },
        });

        if (!user?.passwordHash) return null;

        const passwordMatch = await bcrypt.compare(password, user.passwordHash);
        if (!passwordMatch) return null;

        return {
          id: user.id,
          email: user.email,
          name: user.name,
        };
      },
    }),
  ],
  callbacks: {
    jwt({ token, user }) {
      if (user) {
        token.id = user.id;
      }
      return token;
    },
    session({ session, token }) {
      if (token && session.user) {
        session.user.id = token.id as string;
      }
      return session;
    },
  },
});
```

**Step 3: Add jsonwebtoken dependency**

```bash
pnpm --filter @fiskai/web add jsonwebtoken
pnpm --filter @fiskai/web add -D @types/jsonwebtoken
```

**Step 4: Commit**

```bash
git add apps/web/src/lib/auth.ts
git commit -m "feat(auth): add NextAuth v5 configuration"
```

---

## Task 8: Create Auth API Routes

**Step 1: Create NextAuth route handler**

Create `apps/web/src/app/api/auth/[...nextauth]/route.ts`:
```typescript
import { handlers } from '@/lib/auth';
export const { GET, POST } = handlers;
```

**Step 2: Copy and adapt OTP API routes**

```bash
mkdir -p apps/web/src/app/api/auth/send-code
mkdir -p apps/web/src/app/api/auth/verify-code
mkdir -p apps/web/src/app/api/auth/check-email
mkdir -p apps/web/src/app/api/auth/register

cp /home/admin/FiskAI/src/app/api/auth/send-code/route.ts apps/web/src/app/api/auth/send-code/
cp /home/admin/FiskAI/src/app/api/auth/verify-code/route.ts apps/web/src/app/api/auth/verify-code/
cp /home/admin/FiskAI/src/app/api/auth/check-email/route.ts apps/web/src/app/api/auth/check-email/
cp /home/admin/FiskAI/src/app/api/auth/register/route.ts apps/web/src/app/api/auth/register/
```

**Step 3: Update imports in copied files**

Update all copied API routes to use:
- `import { db } from '@fiskai/db'` instead of `import { db } from '@/lib/db'`
- Remove any rate limiting imports for now (simplify for MVP)

**Step 4: Commit**

```bash
git add apps/web/src/app/api/auth
git commit -m "feat(auth): add auth API routes (OTP, check-email, register)"
```

---

## Task 9: Create Auth Pages

**Step 1: Create auth layout**

Create `apps/web/src/app/(auth)/layout.tsx`:
```typescript
export default function AuthLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <div className="dark min-h-screen bg-black">
      {children}
    </div>
  );
}
```

**Step 2: Create main auth page**

Create `apps/web/src/app/(auth)/auth/page.tsx`:
```typescript
import { redirect } from 'next/navigation';
import { auth } from '@/lib/auth';
import { AuthFlow } from '@/components/auth';

export default async function AuthPage() {
  const session = await auth();
  if (session) redirect('/dashboard');

  return <AuthFlow />;
}
```

**Step 3: Commit**

```bash
git add apps/web/src/app/\(auth\)
git commit -m "feat(auth): add auth pages with glassmorphic AuthFlow"
```

---

## Task 10: Create Protected Dashboard

**Step 1: Create app layout**

Create `apps/web/src/app/(app)/layout.tsx`:
```typescript
import { redirect } from 'next/navigation';
import { auth, signOut } from '@/lib/auth';

export default async function AppLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await auth();
  if (!session) redirect('/auth');

  return (
    <div className="min-h-screen bg-gray-50">
      <header className="bg-white border-b">
        <div className="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
          <h1 className="text-xl font-bold">FiskAI</h1>
          <div className="flex items-center gap-4">
            <span className="text-sm text-gray-600">{session.user?.email}</span>
            <form action={async () => {
              'use server';
              await signOut({ redirectTo: '/auth' });
            }}>
              <button type="submit" className="text-sm text-gray-600 hover:text-gray-900">
                Odjava
              </button>
            </form>
          </div>
        </div>
      </header>
      <main className="max-w-7xl mx-auto px-4 py-8">{children}</main>
    </div>
  );
}
```

**Step 2: Create dashboard page**

Create `apps/web/src/app/(app)/dashboard/page.tsx`:
```typescript
import { auth } from '@/lib/auth';
import { Card, CardHeader, CardTitle, CardContent } from '@fiskai/ui';

export default async function DashboardPage() {
  const session = await auth();

  return (
    <div>
      <h1 className="text-2xl font-bold mb-6">
        Dobrodošli, {session?.user?.name || 'korisniče'}!
      </h1>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <Card>
          <CardHeader>
            <CardTitle>Računi</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-3xl font-bold">0</p>
            <p className="text-sm text-gray-500">Ukupno izdanih računa</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Ovaj mjesec</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-3xl font-bold">0,00 €</p>
            <p className="text-sm text-gray-500">Ukupan promet</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader>
            <CardTitle>Status</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-sm text-yellow-600">⚠️ Potrebno postaviti tvrtku</p>
          </CardContent>
        </Card>
      </div>
    </div>
  );
}
```

**Step 3: Commit**

```bash
git add apps/web/src/app/\(app\)
git commit -m "feat(app): add protected dashboard"
```

---

## Task 11: Update Home Page

**Step 1: Update home page**

Replace `apps/web/src/app/page.tsx`:
```typescript
import { redirect } from 'next/navigation';
import { auth } from '@/lib/auth';

export default async function HomePage() {
  const session = await auth();

  if (session) {
    redirect('/dashboard');
  } else {
    redirect('/auth');
  }
}
```

**Step 2: Commit**

```bash
git add apps/web/src/app/page.tsx
git commit -m "feat(home): redirect to auth or dashboard"
```

---

## Task 12: Fix Import Paths in Copied Components

**Step 1: Update all @/ imports in auth components**

Search and replace in `apps/web/src/components/auth/`:
- `@/lib/db` → `@fiskai/db`
- `@/components/ui` → `@fiskai/ui`
- Fix any other broken imports

**Step 2: Simplify useAuthFlow.ts**

Remove passkey-related code, simplify redirects for MVP.

**Step 3: Test typecheck**

```bash
pnpm typecheck
```

Fix any TypeScript errors.

**Step 4: Commit**

```bash
git add -A
git commit -m "fix(auth): update imports for monorepo structure"
```

---

## Task 13: Integration Test

**Step 1: Start dev server**

```bash
pnpm dev
```

**Step 2: Test the flow**

1. Open http://localhost:3000 → should redirect to /auth
2. Enter email → should check if user exists
3. If new user → show registration form
4. Fill registration → should create user and send OTP
5. Enter OTP → should verify and redirect to /dashboard
6. Click Odjava → should return to /auth

**Step 3: Verify database**

```bash
PGPASSWORD=PASSWORD psql -h 100.64.123.81 -p 5434 -U fiskai -d fiskai_fresh -c "SELECT id, email, name FROM users"
```

---

## Task 14: Final Cleanup

**Step 1: Run checks**

```bash
pnpm typecheck
pnpm build
```

**Step 2: Update ROADMAP.md**

Mark Sprint 0.2 as complete.

**Step 3: Final commit**

```bash
git add -A
git commit -m "chore: sprint 0.2 complete - auth flow working"
```

---

## Sprint 0.2 Gate Checklist

- [ ] Glassmorphic auth UI renders correctly
- [ ] Mouse-following spotlight effect works
- [ ] Floating orbs animate based on step
- [ ] User can enter email (identify step)
- [ ] New users see registration form
- [ ] Existing users see login form
- [ ] OTP codes are sent and verified
- [ ] Dashboard is protected
- [ ] Logout works
- [ ] `pnpm build` passes
- [ ] `pnpm typecheck` passes

---

## Key Components Reused from Old Repo

| Component | Features |
|-----------|----------|
| `GlassCard` | Mouse-following spotlight, 3D tilt, glassmorphic blur |
| `FloatingOrbs` | 6 animated orbs, state-based colors |
| `AnimatedButton` | Loading spinner, success checkmark, error state |
| `OTPInput` | Auto-advance, paste support, error shake |
| `AuthFlow` | Multi-step orchestrator with Framer Motion |
| `useAuthFlow` | State management, API calls, step transitions |
| Step components | IdentifyStep, AuthenticateStep, RegisterStep, VerifyStep, etc. |

---

## Files Summary

**Copied from old repo:**
- `src/components/auth/*` (all auth UI components)
- `src/lib/validations/auth.ts`
- `src/app/api/auth/send-code/route.ts`
- `src/app/api/auth/verify-code/route.ts`
- `src/app/api/auth/check-email/route.ts`
- `src/app/api/auth/register/route.ts`

**Created new:**
- `src/lib/auth.ts` (NextAuth config, adapted)
- `src/app/(auth)/layout.tsx`
- `src/app/(auth)/auth/page.tsx`
- `src/app/(app)/layout.tsx`
- `src/app/(app)/dashboard/page.tsx`
- `src/app/page.tsx` (redirect logic)
